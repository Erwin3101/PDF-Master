<!DOCTYPE html>
<html lang="es" class="light"> <!-- Clase inicial para control de tema -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Master Suite v5.2 - Enhanced</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración de Tailwind para Modo Oscuro manual
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9',
                            muted: '#94a3b8',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- LIBRERÍAS PRINCIPALES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- JSZip para descargar imágenes y PDFs en ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- LIBRERÍA SORTABLEJS (PARA DRAG & DROP) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- LIBRERÍAS DE COMPATIBILIDAD DE IMÁGENES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- Google Fonts for Signatures -->
    <link
        href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script&family=Sacramento&family=Allura&display=swap"
        rel="stylesheet">
    <script>
        // Configuración del worker de PDF.js
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .dark .drag-active {
            background-color: #1e3a8a;
            border-color: #60a5fa;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Estilos de botones de herramientas */
        .tool-btn.active {
            background-color: #1e293b;
            color: white;
        }

        .dark .tool-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        .tool-btn.inactive {
            background-color: white;
            color: #64748b;
        }

        .tool-btn.inactive:hover {
            background-color: #f1f5f9;
            color: #334155;
        }

        .dark .tool-btn.inactive {
            background-color: #1e293b;
            color: #94a3b8;
        }

        .dark .tool-btn.inactive:hover {
            background-color: #334155;
            color: #e2e8f0;
        }

        .template-option.selected {
            border-color: #ec4899;
            background-color: #fdf2f8;
            color: #db2777;
        }

        .dark .template-option.selected {
            background-color: #831843;
            color: #fbcfe8;
            border-color: #ec4899;
        }

        .template-option:hover {
            border-color: #f472b6;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ocultar scrollbar pero permitir scroll */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Asegurar altura igual en tarjetas */
        .home-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Estilos para Drag & Drop */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #cbd5e1;
            border: 2px dashed #94a3b8;
        }

        .dark .sortable-ghost {
            background-color: #334155;
            border-color: #64748b;
        }

        .cursor-grab {
            cursor: grab;
        }

        .cursor-grab:active {
            cursor: grabbing;
        }

        /* Estilos para inputs de configuración */
        .config-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>

<body
    class="bg-slate-100 dark:bg-slate-950 min-h-screen font-sans text-slate-800 dark:text-slate-200 transition-colors duration-300 flex flex-col">

    <!-- NAV PRINCIPAL -->
    <nav
        class="bg-white dark:bg-slate-900 shadow-md sticky top-0 z-50 transition-colors duration-300 border-b dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between py-3 gap-4">

                <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                    <a href="#" onclick="switchTool('home')"
                        class="flex items-center gap-2 hover:opacity-80 transition-opacity min-w-fit">
                        <div class="bg-blue-600 p-2 rounded-lg text-white">
                            <i data-lucide="box" class="w-6 h-6"></i>
                        </div>
                        <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">PDF <span
                                class="text-blue-600 dark:text-blue-400">Master</span></h1>
                    </a>

                    <!-- Botón Modo Oscuro (Móvil y Desktop) -->
                    <button onclick="toggleDarkMode()"
                        class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                        title="Cambiar Tema">
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                        <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                    </button>

                    <!-- Botón Idioma -->
                    <button onclick="toggleLanguage()"
                        class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors font-bold text-sm w-10 h-10 flex items-center justify-center"
                        title="Cambiar Idioma">
                        <span id="lang-btn-text">ES</span>
                    </button>
                </div>

                <div class="flex items-center gap-2 animate-fade-in">
                    <div
                        class="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl gap-1 overflow-x-auto max-w-full w-full md:w-auto scrollbar-hide border dark:border-slate-800">
                        <button onclick="switchTool('home')" id="nav-home"
                            class="tool-btn active px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_home">
                            <i data-lucide="home" class="w-4 h-4"></i> Inicio
                        </button>
                        </button>

                        <button onclick="switchTool('compress')" id="nav-compress"
                            class="tool-btn inactive px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_compress">
                            <i data-lucide="minimize-2" class="w-4 h-4"></i> Comprimir
                        </button>
                        <button onclick="switchTool('img2pdf')" id="nav-img2pdf"
                            class="tool-btn inactive px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_img2pdf">
                            <i data-lucide="image" class="w-4 h-4"></i> Img a PDF
                        </button>
                        <button onclick="switchTool('nup')" id="nav-nup"
                            class="tool-btn inactive px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_nup">
                            <i data-lucide="layout-grid" class="w-4 h-4"></i> Resumir
                        </button>
                        <button onclick="switchTool('split')" id="nav-split"
                            class="tool-btn inactive px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_split">
                            <i data-lucide="scissors" class="w-4 h-4"></i> Dividir
                        </button>
                        <button onclick="switchTool('merge')" id="nav-merge"
                            class="tool-btn inactive px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_merge">
                            <i data-lucide="combine" class="w-4 h-4"></i> Unir
                        </button>
                        <button onclick="switchTool('pdf2img')" id="nav-pdf2img"
                            class="tool-btn inactive px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap"
                            data-i18n="nav_pdf2img">
                            <i data-lucide="images" class="w-4 h-4"></i> PDF a Img
                        </button>
                    </div>

                    <div class="relative group ml-1 z-50">
                        <button id="nav-dropdown-btn"
                            class="flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 font-bold text-slate-700 dark:text-slate-200 transition-colors border dark:border-slate-700 h-[40px]">
                            <i data-lucide="grid" class="w-4 h-4"></i>
                            <span class="hidden lg:inline" data-i18n="nav_all">Todas</span>
                            <i data-lucide="chevron-down"
                                class="w-4 h-4 transition-transform group-hover:rotate-180"></i>
                        </button>
                        <div
                            class="absolute right-0 top-full mt-2 w-72 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 hidden group-hover:block p-2 z-50 animate-fade-in max-h-[80vh] overflow-y-auto">

                            <div class="px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider"
                                data-i18n="drop_organize">Organizar
                            </div>
                            <button onclick="switchTool('merge')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-md"><i
                                        data-lucide="combine" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_merge">Unir PDF</span>
                            </button>
                            <button onclick="switchTool('compress')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-teal-100 dark:bg-teal-900/30 text-teal-600 rounded-md"><i
                                        data-lucide="minimize-2" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_compress">Comprimir</span>
                            </button>
                            <button onclick="switchTool('split')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-md"><i
                                        data-lucide="scissors" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_split">Dividir PDF</span>
                            </button>
                            <button onclick="switchTool('nup')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 rounded-md"><i
                                        data-lucide="layout-grid" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_nup">Resumir PDF</span>
                            </button>

                            <div class="px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-2"
                                data-i18n="drop_convert">
                                Convertir
                            </div>
                            <button onclick="switchTool('img2pdf')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-md"><i
                                        data-lucide="image" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_img2pdf">Img a PDF</span>
                            </button>
                            <button onclick="switchTool('pdf2img')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-md"><i
                                        data-lucide="image-minus" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_pdf2img">PDF a Img</span>
                            </button>
                            <button onclick="switchTool('ocr')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 rounded-md"><i
                                        data-lucide="text-select" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_ocr">OCR / Texto</span>
                            </button>
                            <button onclick="switchTool('scan-enhancer')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-gray-100 dark:bg-gray-800 text-gray-600 rounded-md"><i
                                        data-lucide="wand-2" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_scan">Mejorar Escaneo</span>
                            </button>

                            <div class="px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-2"
                                data-i18n="drop_edit">Editar
                            </div>

                            <button onclick="switchTool('watermark')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-md"><i
                                        data-lucide="stamp" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_watermark">Marca Agua</span>
                            </button>
                            <button onclick="switchTool('pagenumbers')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 rounded-md"><i
                                        data-lucide="hash" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_pagenum">Números Pág</span>
                            </button>
                            <button onclick="switchTool('sign')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div
                                    class="p-1.5 bg-blue-800/10 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 rounded-md">
                                    <i data-lucide="pen-tool" class="w-4 h-4"></i>
                                </div> <span data-i18n="drop_sign">Firmar PDF</span>
                            </button>

                            <div class="px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-2"
                                data-i18n="drop_others">Otros
                            </div>
                            <button onclick="switchTool('poster')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-pink-100 dark:bg-pink-900/30 text-pink-600 rounded-md"><i
                                        data-lucide="grid-3x3" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_poster">Póster</span>
                            </button>
                            <button onclick="switchTool('collage')"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-300 transition-colors">
                                <div class="p-1.5 bg-teal-100 dark:bg-teal-900/30 text-teal-600 rounded-md"><i
                                        data-lucide="layout-dashboard" class="w-4 h-4"></i></div> <span
                                    data-i18n="drop_collage">Collage</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8 flex-grow w-full">

        <!-- SECCIÓN DE INICIO -->
        <section id="section-home" class="block animate-fade-in">
            <div class="text-center py-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 dark:text-white mb-6 transition-colors"
                    data-i18n="hero_title">
                    Suite de Herramientas <span class="text-blue-600 dark:text-blue-400">PDF</span>
                </h1>
                <p class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto mb-12 transition-colors"
                    data-i18n="hero_desc">
                    Todas las herramientas que necesitas en un solo lugar. 100% Privado y seguro en tu navegador.
                </p>

                <!-- GRID DE TARJETAS UNIFICADO (10 Herramientas: 5 columnas x 2 filas) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 max-w-7xl mx-auto mt-6">

                    <!-- Editor PDF (NUEVO) -->


                    <!-- 1. Img a PDF -->
                    <button onclick="switchTool('img2pdf')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-blue-500 transition-all h-full group">
                        <div
                            class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="image" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors"
                            data-i18n="card_img2pdf_title">
                            Img a PDF</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_img2pdf_desc">
                            Convierte fotos a PDF.</p>
                    </button>

                    <!-- Comprimir PDF (NUEVO) -->
                    <button onclick="switchTool('compress')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-teal-500 transition-all h-full group">
                        <div
                            class="bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="minimize-2" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors"
                            data-i18n="card_compress_title">
                            Comprimir PDF</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_compress_desc">Reduce
                            el tamaño del archivo.</p>
                    </button>

                    <!-- 2. Resumir (N-UP) -->
                    <button onclick="switchTool('nup')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-indigo-500 transition-all h-full group">
                        <div
                            class="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="layout-grid" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors"
                            data-i18n="card_nup_title">
                            Resumir PDF</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_nup_desc">Varias
                            páginas en una.</p>
                    </button>

                    <!-- 3. Dividir -->
                    <button onclick="switchTool('split')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-orange-500 transition-all h-full group">
                        <div
                            class="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="scissors" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-orange-600 dark:group-hover:text-orange-400 transition-colors"
                            data-i18n="card_split_title">
                            Dividir / Rotar</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_split_desc">Elimina o
                            rota páginas.</p>
                    </button>

                    <!-- 4. Unir -->
                    <button onclick="switchTool('merge')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-purple-500 transition-all h-full group">
                        <div
                            class="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="combine" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors"
                            data-i18n="card_merge_title">
                            Unir PDFs</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_merge_desc">Combina
                            múltiples archivos.</p>
                    </button>

                    <!-- 5. PDF a Img -->
                    <button onclick="switchTool('pdf2img')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-green-500 transition-all h-full group">
                        <div
                            class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="image-minus" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors"
                            data-i18n="card_pdf2img_title">
                            PDF a Imágenes</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_pdf2img_desc">Extrae
                            páginas como JPG.</p>
                    </button>

                    <!-- OCR (NUEVO) -->
                    <button onclick="switchTool('ocr')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-yellow-500 transition-all h-full group">
                        <div
                            class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="text-select" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-yellow-600 dark:group-hover:text-yellow-400 transition-colors"
                            data-i18n="card_ocr_title">
                            OCR / Texto</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_ocr_desc">Extrae
                            texto editable de imágenes.
                        </p>
                    </button>

                    <!-- Scan Enhancer (NUEVO) -->
                    <button onclick="switchTool('scan-enhancer')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-gray-500 transition-all h-full group">
                        <div
                            class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="wand-2" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-gray-600 dark:group-hover:text-gray-400 transition-colors"
                            data-i18n="card_scan_title">
                            Mejorar Escaneo</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_scan_desc">Limpia y
                            binariza fotos de
                            documentos.</p>
                    </button>

                    <!-- 6. Poster -->
                    <button onclick="switchTool('poster')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-pink-500 transition-all h-full group">
                        <div
                            class="bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="grid-3x3" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-pink-600 dark:group-hover:text-pink-400 transition-colors"
                            data-i18n="card_poster_title">
                            Póster Gigante</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_poster_desc">Imprime
                            en múltiples A4.</p>
                    </button>

                    <!-- 7. Collage -->
                    <button onclick="switchTool('collage')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-teal-500 transition-all h-full group">
                        <div
                            class="bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors"
                            data-i18n="card_collage_title">
                            Estudio Collage</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_collage_desc">Crea
                            composiciones.</p>
                    </button>

                    <!-- 8. Watermark -->
                    <button onclick="switchTool('watermark')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-red-300 dark:hover:border-red-500 transition-all h-full group">
                        <div
                            class="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="stamp" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-red-600 dark:group-hover:text-red-400 transition-colors"
                            data-i18n="card_watermark_title">
                            Marca de Agua</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_watermark_desc">Pon
                            tu sello en todas las páginas.
                        </p>
                    </button>

                    <!-- 9. Page Numbers -->
                    <button onclick="switchTool('pagenumbers')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-cyan-300 dark:hover:border-cyan-500 transition-all h-full group">
                        <div
                            class="bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="hash" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition-colors"
                            data-i18n="card_pagenum_title">
                            Números de Pág</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_pagenum_desc">Añade
                            numeración auto.</p>
                    </button>

                    <!-- 10. Sign -->
                    <button onclick="switchTool('sign')"
                        class="home-card bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-800 text-left hover:border-blue-800 dark:hover:border-blue-400 transition-all h-full group">
                        <div
                            class="bg-blue-800/10 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 w-12 h-12 rounded-xl flex items-center justify-center mb-4">
                            <i data-lucide="pen-tool" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 group-hover:text-blue-800 dark:group-hover:text-blue-300 transition-colors"
                            data-i18n="card_sign_title">
                            Firmar PDF</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="card_sign_desc">Dibuja y
                            coloca tu firma.</p>
                    </button>
                </div>


            </div>
        </section>

        <!-- 11. COMPRIMIR PDF (NUEVO) -->
        <section id="section-compress" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-teal-50/50 dark:bg-teal-900/20 p-6 border-b border-teal-100 dark:border-teal-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_compress_title"><i data-lucide="minimize-2"
                            class="text-teal-600 dark:text-teal-400"></i> Comprimir PDF</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_compress_desc">Reduce el
                        tamaño de tu archivo PDF.</p>
                </div>
                <div class="p-6">
                    <div id="compress-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-compress').click()">
                            <i data-lucide="file-check"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Selecciona el PDF a comprimir</p>
                            <input type="file" id="file-input-compress" class="hidden" accept=".pdf">
                        </div>
                    </div>

                    <div id="compress-workspace" class="hidden">
                        <div
                            class="bg-slate-50 dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 mb-6">
                            <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4">Nivel de Compresión</h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="cursor-pointer relative">
                                    <input type="radio" name="compress-level" value="standard" class="peer sr-only"
                                        checked>
                                    <div
                                        class="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-teal-500 dark:hover:border-teal-500 peer-checked:border-teal-500 peer-checked:bg-teal-50 dark:peer-checked:bg-teal-900/20 transition-all h-full">
                                        <div class="font-bold text-slate-800 dark:text-slate-200 mb-1">Estándar
                                            (Recomendado)</div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Optimiza la estructura del
                                            PDF. Mantiene el texto seleccionable y buena calidad. Ideal para la mayoría
                                            de documentos.</p>
                                    </div>
                                </label>

                                <label class="cursor-pointer relative">
                                    <input type="radio" name="compress-level" value="strong" class="peer sr-only">
                                    <div
                                        class="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-teal-500 dark:hover:border-teal-500 peer-checked:border-teal-500 peer-checked:bg-teal-50 dark:peer-checked:bg-teal-900/20 transition-all h-full">
                                        <div class="font-bold text-slate-800 dark:text-slate-200 mb-1">Fuerte
                                            (Rasterizado)</div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Convierte páginas a
                                            imágenes. <span class="text-red-500 font-bold">El texto dejará de ser
                                                seleccionable.</span> Máxima reducción para escaneos.</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <button onclick="resetCompress()"
                                class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 font-medium">Cancelar</button>
                            <button onclick="compressPDF()"
                                class="bg-teal-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-teal-700 transition-colors shadow-lg shadow-teal-200 dark:shadow-none flex items-center gap-2">
                                <i data-lucide="minimize-2"></i> Comprimir y Descargar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 1. IMAGEN A PDF (MEJORADO CON OPCIONES TIPO FREEPDFCONVERT) -->
        <section id="section-img2pdf" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-blue-50/50 dark:bg-blue-900/20 p-6 border-b border-blue-100 dark:border-blue-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_img2pdf_title"><i data-lucide="image"
                            class="text-blue-600 dark:text-blue-400"></i> Imagen a PDF</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_img2pdf_desc">Convierte tus
                        imágenes con opciones de
                        personalización profesionales.</p>
                </div>
                <div class="flex border-b border-slate-200 dark:border-slate-800">
                    <button onclick="setImgMode('standard')" id="tab-std"
                        class="flex-1 py-3 text-sm font-medium border-b-2 border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400 bg-blue-50/30 dark:bg-blue-900/20">Estándar
                        (Configurable)</button>
                    <button onclick="setImgMode('duplicate')" id="tab-dup"
                        class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">Duplicar
                        (2x1)</button>
                </div>

                <div class="p-6">
                    <!-- NUEVO: Panel de Opciones de Configuración -->
                    <div id="standard-options"
                        class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label
                                    class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">Tamaño
                                    de Página</label>
                                <select id="img-page-size"
                                    class="config-select w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="fit" class="font-semibold">Igual que el tamaño de la imagen</option>
                                    <option disabled>──────────</option>
                                    <option value="a4" selected>A4 (210x297 mm)</option>
                                    <option value="a0">A0 (841x1189 mm)</option>
                                    <option value="a1">A1 (594x841 mm)</option>
                                    <option value="a2">A2 (420x594 mm)</option>
                                    <option value="a3">A3 (297x420 mm)</option>
                                    <option value="a5">A5 (148.5x210 mm)</option>
                                    <option value="a6">A6 (105x148.5 mm)</option>
                                    <option value="a7">A7 (74x105 mm)</option>
                                    <option value="a8">A8 (52x74 mm)</option>
                                    <option value="a9">A9 (37x52 mm)</option>
                                    <option value="a10">A10 (26x37 mm)</option>
                                    <option disabled>──────────</option>
                                    <option value="letter">Letter (216x279 mm)</option>
                                    <option value="legal">Legal (216x356 mm)</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">Orientación</label>
                                <select id="img-orientation"
                                    class="config-select w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="auto">Automática</option>
                                    <option value="p">Vertical (Portrait)</option>
                                    <option value="l">Horizontal (Landscape)</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">Márgenes</label>
                                <select id="img-margin"
                                    class="config-select w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="none">Sin Márgenes</option>
                                    <option value="small">Pequeños</option>
                                    <option value="normal">Normales</option>
                                </select>
                            </div>
                        </div>

                        <script>
                            // Agregar listeners para actualizar preview al cambiar opciones
                            ['img-page-size', 'img-orientation', 'img-margin'].forEach(id => {
                                document.getElementById(id).addEventListener('change', renderImg2PdfPreview);
                            });
                        </script>

                        <!-- NUEVA OPCIÓN: CREAR ARCHIVOS INDEPENDIENTES -->
                        <div class="flex items-center gap-3 pt-2 border-t border-slate-200 dark:border-slate-700 mt-2">
                            <div
                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="img-separate-files"
                                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" />
                                <label for="img-separate-files"
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>
                            <label for="img-separate-files"
                                class="text-sm font-medium text-slate-700 dark:text-slate-300 cursor-pointer select-none flex items-center gap-2">
                                <i data-lucide="files" class="w-4 h-4 text-blue-500"></i>
                                Crear archivos PDF independientes (ZIP)
                            </label>
                        </div>
                    </div>

                    <!-- BOTÓN DE PREVISUALIZACIÓN -->
                    <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                        <button onclick="togglePreviewImg2Pdf()"
                            class="text-sm font-bold text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-2">
                            <i data-lucide="eye" class="w-4 h-4"></i> Ver Previsualización de Página
                        </button>
                    </div>
                </div>

                <!-- AREA DE PREVISUALIZACIÓN (HIDDEN BY DEFAULT) -->
                <div id="img2pdf-preview-area"
                    class="hidden mb-6 bg-slate-200/50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 flex flex-col items-center">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Vista Previa (Primera Imagen)
                    </h4>
                    <div class="relative shadow-xl overflow-hidden bg-white">
                        <canvas id="img2pdf-preview-canvas" class="max-w-full max-h-[500px]"></canvas>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">La vista previa muestra cómo se verá la primera imagen con la
                        configuración actual.</p>
                </div>

                <!-- Mensaje informativo sobre el modo duplicar (ACTUALIZADO) -->
                <div id="duplicate-info"
                    class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-xl text-sm border border-blue-100 dark:border-blue-800 flex items-start gap-3">
                    <i data-lucide="info" class="w-5 h-5 shrink-0 mt-0.5"></i>
                    <div>
                        <strong>Modo Duplicar Inteligente:</strong><br>
                        Se colocarán 2 copias de la imagen por página. El sistema intentará detectar automáticamente la
                        mejor orientación si seleccionas "Automática".
                    </div>
                </div>

                <div id="drop-zone-img"
                    class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                    onclick="document.getElementById('file-input-img').click()">
                    <i data-lucide="upload" class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                    <p class="font-medium text-slate-700 dark:text-slate-300">Sube imágenes o PDFs</p>
                    <p class="text-xs text-slate-400 mt-1">Arrastra y suelta aquí</p>
                    <input type="file" id="file-input-img" class="hidden" multiple
                        accept="image/*,.pdf,.heic,.heif,.tiff,.tif,.webp,.bmp">
                </div>

                <!-- GRID DE IMÁGENES -->
                <div id="img-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 empty:hidden"></div>
                <button onclick="generateImgPDF()" id="btn-gen-img"
                    class="hidden w-full mt-6 bg-slate-900 dark:bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-800 dark:hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 dark:shadow-none">Descargar
                    PDF Convertido</button>
            </div>
            </div>
        </section>

        <!-- 2. RESUMIR PDF (N-UP) -->
        <section id="section-nup" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div
                    class="bg-indigo-50/50 dark:bg-indigo-900/20 p-6 border-b border-indigo-100 dark:border-indigo-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_nup_title"><i data-lucide="layout-grid"
                            class="text-indigo-600 dark:text-indigo-400"></i> Resumir PDF</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_nup_desc">Junta varias páginas
                        en una sola para ahorrar
                        impresión.</p>
                </div>
                <div class="p-6">
                    <div id="nup-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-nup').click()">
                            <i data-lucide="file-text"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Selecciona tu PDF</p>
                            <input type="file" id="file-input-nup" class="hidden" accept=".pdf">
                        </div>
                    </div>

                    <div id="nup-options" class="hidden mt-6">
                        <div
                            class="flex items-center gap-4 mb-6 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                            <div class="flex-1">
                                <label
                                    class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Páginas
                                    por hoja:</label>
                                <select id="nup-count"
                                    class="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200">
                                    <option value="2">2 Páginas (1x2)</option>
                                    <option value="4">4 Páginas (2x2)</option>
                                    <option value="6" selected>6 Páginas (2x3)</option>
                                    <option value="9">9 Páginas (3x3)</option>
                                </select>
                            </div>
                            <div class="flex-none pt-6">
                                <button onclick="resetNUp()"
                                    class="text-red-500 hover:text-red-700 font-medium text-sm">Cambiar PDF</button>
                            </div>
                        </div>
                        <button onclick="generateNUpPDF()"
                            class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 dark:shadow-none flex justify-center items-center gap-2">
                            <i data-lucide="printer"></i> Generar PDF Resumido
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. DIVIDIR / ROTAR (MEJORADO + DRAG DROP) -->
        <section id="section-split" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div
                    class="bg-orange-50/50 dark:bg-orange-900/20 p-6 border-b border-orange-100 dark:border-orange-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_split_title">
                        <i data-lucide="scissors" class="text-orange-600 dark:text-orange-400"></i> Editor de Páginas
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_split_desc">Arrastra para
                        reordenar, elimina páginas o
                        gíralas.</p>
                </div>

                <div class="p-6">
                    <div id="split-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-split').click()">
                            <i data-lucide="file-text"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Selecciona un archivo PDF</p>
                            <input type="file" id="file-input-split" class="hidden" accept=".pdf">
                        </div>
                    </div>

                    <div id="split-workspace" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200">Editor (<span
                                    id="split-page-count">0</span> páginas)</h3>
                            <button onclick="resetSplit()"
                                class="text-sm text-red-500 hover:text-red-700 dark:hover:text-red-400 font-medium border border-red-200 dark:border-red-900 px-3 py-1 rounded bg-red-50 dark:bg-red-900/20">Cancelar
                                / Nuevo</button>
                        </div>
                        <div id="pages-container"
                            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl max-h-[60vh] overflow-y-auto border border-slate-200 dark:border-slate-700">
                        </div>
                        <button onclick="downloadSplitPDF()"
                            class="w-full mt-6 bg-orange-600 text-white py-3 rounded-xl font-semibold hover:bg-orange-700 transition-colors shadow-lg shadow-orange-200 dark:shadow-none flex justify-center items-center gap-2">
                            <i data-lucide="download"></i> Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. UNIR (MERGE) - DRAG & DROP ENABLED -->
        <section id="section-merge" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div
                    class="bg-purple-50/50 dark:bg-purple-900/20 p-6 border-b border-purple-100 dark:border-purple-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_merge_title"><i data-lucide="combine"
                            class="text-purple-600 dark:text-purple-400"></i> Unir y Organizar
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_merge_desc">Arrastra para
                        cambiar el orden de las páginas.
                    </p>
                </div>
                <div class="p-6">
                    <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer mb-6"
                        onclick="document.getElementById('file-input-merge').click()">
                        <i data-lucide="files" class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                        <p class="font-medium text-slate-700 dark:text-slate-300">Añadir PDFs para unir</p>
                        <input type="file" id="file-input-merge" class="hidden" multiple accept=".pdf">
                    </div>

                    <div id="merge-workspace" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200">Vista Previa (<span
                                    id="merge-page-count">0</span> páginas)</h3>
                            <button onclick="resetMerge()"
                                class="text-sm text-red-500 hover:text-red-700 dark:hover:text-red-400 font-medium border border-red-200 dark:border-red-900 px-3 py-1 rounded bg-red-50 dark:bg-red-900/20">Limpiar
                                Todo</button>
                        </div>

                        <div id="merge-grid"
                            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl max-h-[60vh] overflow-y-auto border border-slate-200 dark:border-slate-700">
                        </div>

                        <button onclick="mergePDFs()" id="btn-merge"
                            class="w-full mt-6 bg-purple-600 text-white py-3 rounded-xl font-semibold hover:bg-purple-700 transition-colors shadow-lg shadow-purple-200 dark:shadow-none flex justify-center items-center gap-2">
                            <i data-lucide="download"></i> Unir y Descargar
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. PDF A IMÁGENES (MEJORADO + DRAG DROP) -->
        <section id="section-pdf2img" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div
                    class="bg-emerald-50/50 dark:bg-emerald-900/20 p-6 border-b border-emerald-100 dark:border-emerald-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_pdf2img_title">
                        <i data-lucide="images" class="text-emerald-600 dark:text-emerald-400"></i> PDF a Imágenes (JPG)
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_pdf2img_desc">Arrastra para
                        reordenar, rota o selecciona
                        antes de descargar.</p>
                </div>
                <div class="p-6">
                    <div id="p2i-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-p2i').click()">
                            <i data-lucide="image-plus"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Sube tu PDF</p>
                            <input type="file" id="file-input-p2i" class="hidden" accept=".pdf">
                        </div>
                    </div>
                    <div id="p2i-workspace" class="hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                            <span class="text-sm text-slate-500 dark:text-slate-400 font-medium">Revisa, rota o elimina
                                antes de descargar</span>
                            <div class="flex gap-2">
                                <button onclick="resetP2I()"
                                    class="text-sm text-red-500 hover:text-red-700 dark:hover:text-red-400 border border-red-200 dark:border-red-900 px-3 py-2 rounded bg-red-50 dark:bg-red-900/20">Cancelar</button>
                                <button onclick="downloadAllImagesZip()"
                                    class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition-colors flex items-center gap-2 shadow-lg shadow-emerald-200 dark:shadow-none">
                                    <i data-lucide="archive"></i> Descargar Todo (ZIP)
                                </button>
                            </div>
                        </div>
                        <div id="p2i-grid"
                            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 max-h-[60vh] overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. PÓSTER -->
        <section id="section-poster" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-teal-50/50 dark:bg-teal-900/20 p-6 border-b border-teal-100 dark:border-teal-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_poster_title"><i data-lucide="grid-3x3"
                            class="text-teal-600 dark:text-teal-400"></i> Creador de Póster HD
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_poster_desc">Alta calidad de
                        impresión. Soporta múltiples
                        archivos.</p>
                </div>
                <div class="p-6">
                    <div id="poster-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-poster').click()">
                            <i data-lucide="image-plus"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Sube Imágenes o PDFs (Varios
                                permitidos)</p>
                            <!-- MULTIPLE AÑADIDO -->
                            <input type="file" id="file-input-poster" class="hidden" multiple
                                accept="image/*,.pdf,.heic,.heif">
                        </div>
                    </div>
                    <div id="poster-workspace" class="hidden">
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="w-full md:w-1/3 space-y-4">
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm uppercase">
                                            Configuración</h3>
                                        <!-- NAVEGACIÓN SENCILLA -->
                                        <div class="flex gap-2" id="poster-nav">
                                            <button onclick="prevPoster()"
                                                class="p-1 bg-white dark:bg-slate-700 rounded border dark:border-slate-600 hover:bg-slate-100"><i
                                                    data-lucide="arrow-left" class="w-4 h-4"></i></button>
                                            <span class="text-xs font-bold py-1" id="poster-counter">1/1</span>
                                            <button onclick="nextPoster()"
                                                class="p-1 bg-white dark:bg-slate-700 rounded border dark:border-slate-600 hover:bg-slate-100"><i
                                                    data-lucide="arrow-right" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label
                                                class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Ancho
                                                (Hojas)</label>
                                            <input type="number" id="poster-cols" value="2" min="1" max="10"
                                                class="w-full p-2 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200"
                                                onchange="renderPosterPreview()">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Alto
                                                (Hojas)</label>
                                            <input type="number" id="poster-rows" value="2" min="1" max="10"
                                                class="w-full p-2 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200"
                                                onchange="renderPosterPreview()">
                                        </div>
                                    </div>

                                    <div
                                        class="mb-4 bg-teal-50 dark:bg-teal-900/20 p-3 rounded-lg border border-teal-100 dark:border-teal-800 text-center">
                                        <p class="text-sm font-bold text-teal-800 dark:text-teal-200">
                                            Total de hojas a imprimir: <span id="poster-total-pages"
                                                class="text-lg">4</span>
                                        </p>
                                    </div>

                                    <button onclick="resetPoster()"
                                        class="w-full py-2 text-slate-500 dark:text-slate-400 hover:text-red-500 font-medium text-sm border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors mb-2">Elegir
                                        otros archivos</button>
                                </div>
                                <button onclick="generatePosterPDF()"
                                    class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200 dark:shadow-none transition-all flex justify-center items-center gap-2"><i
                                        data-lucide="printer"></i> Descargar Póster(s)</button>
                            </div>
                            <div
                                class="w-full md:w-2/3 bg-slate-100 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-center p-4 relative overflow-hidden min-h-[300px]">
                                <canvas id="poster-preview-canvas" class="max-w-full max-h-[500px] shadow-2xl"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7. COLLAGE -->
        <section id="section-collage" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-pink-50/50 dark:bg-pink-900/20 p-6 border-b border-pink-100 dark:border-pink-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_collage_title"><i data-lucide="layout-dashboard"
                            class="text-pink-600 dark:text-pink-400"></i> Collage</h2>
                </div>
                <div class="p-6">
                    <div id="collage-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-collage').click()">
                            <i data-lucide="images"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Selecciona Imágenes</p>
                            <input type="file" id="file-input-collage" class="hidden" multiple
                                accept="image/*,.heic,.heif">
                        </div>
                    </div>
                    <div id="collage-workspace" class="hidden">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="w-full lg:w-1/3 space-y-6">
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm">Plantillas
                                    </h3>
                                    <div
                                        class="grid grid-cols-3 sm:grid-cols-4 gap-2 max-h-[200px] overflow-y-auto pr-1">
                                        <!-- Plantillas Básicas -->
                                        <button onclick="setCollageTemplate('grid')" id="tmpl-grid"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all selected">
                                            <div class="text-xs font-semibold dark:text-white">Auto</div>
                                        </button>
                                        <button onclick="setCollageTemplate('mosaic')" id="tmpl-mosaic"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">Mosaico</div>
                                        </button>
                                        <button onclick="setCollageTemplate('pile')" id="tmpl-pile"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">Pila</div>
                                        </button>
                                        <button onclick="setCollageTemplate('strip')" id="tmpl-strip"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">Tira</div>
                                        </button>

                                        <!-- 2 FOTOS -->
                                        <button onclick="setCollageTemplate('2v')" id="tmpl-2v"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2 Col</div>
                                        </button>
                                        <button onclick="setCollageTemplate('2h')" id="tmpl-2h"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2 Filas</div>
                                        </button>

                                        <!-- 3 FOTOS -->
                                        <button onclick="setCollageTemplate('3v')" id="tmpl-3v"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3 Col</div>
                                        </button>
                                        <button onclick="setCollageTemplate('3h')" id="tmpl-3h"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3 Filas</div>
                                        </button>
                                        <button onclick="setCollageTemplate('1u2d')" id="tmpl-1u2d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">1+2</div>
                                        </button>
                                        <button onclick="setCollageTemplate('2u1d')" id="tmpl-2u1d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2+1</div>
                                        </button>
                                        <button onclick="setCollageTemplate('1l2r')" id="tmpl-1l2r"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">1+2L</div>
                                        </button>
                                        <button onclick="setCollageTemplate('2l1r')" id="tmpl-2l1r"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2+1L</div>
                                        </button>

                                        <!-- 4 FOTOS -->
                                        <button onclick="setCollageTemplate('2x2')" id="tmpl-2x2"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2x2</div>
                                        </button>
                                        <button onclick="setCollageTemplate('1u3d')" id="tmpl-1u3d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">1+3</div>
                                        </button>
                                        <button onclick="setCollageTemplate('3u1d')" id="tmpl-3u1d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3+1</div>
                                        </button>
                                        <button onclick="setCollageTemplate('1l3r')" id="tmpl-1l3r"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">1+3L</div>
                                        </button>
                                        <button onclick="setCollageTemplate('3l1r')" id="tmpl-3l1r"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3+1L</div>
                                        </button>

                                        <!-- 5 FOTOS -->
                                        <button onclick="setCollageTemplate('2u3d')" id="tmpl-2u3d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2+3</div>
                                        </button>
                                        <button onclick="setCollageTemplate('3u2d')" id="tmpl-3u2d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3+2</div>
                                        </button>
                                        <button onclick="setCollageTemplate('1l4r')" id="tmpl-1l4r"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">1+4L</div>
                                        </button>

                                        <!-- 6 FOTOS -->
                                        <button onclick="setCollageTemplate('2x3')" id="tmpl-2x3"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">2x3</div>
                                        </button>
                                        <button onclick="setCollageTemplate('3x2')" id="tmpl-3x2"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3x2</div>
                                        </button>
                                        <button onclick="setCollageTemplate('1u5d')" id="tmpl-1u5d"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">1+5</div>
                                        </button>

                                        <!-- 8 FOTOS -->
                                        <button onclick="setCollageTemplate('4x2')" id="tmpl-4x2"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">4x2</div>
                                        </button>

                                        <!-- 9 FOTOS -->
                                        <button onclick="setCollageTemplate('3x3')" id="tmpl-3x3"
                                            class="template-option p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-center hover:bg-white dark:hover:bg-slate-700 transition-all">
                                            <div class="text-xs font-semibold dark:text-white">3x3</div>
                                        </button>

                                    </div>
                                </div>
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <div class="space-y-4">
                                        <div><label
                                                class="flex justify-between text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1"><span>Separación</span><span
                                                    id="gap-val">10px</span></label><input type="range" id="collage-gap"
                                                min="0" max="50" value="10" class="w-full accent-pink-600"
                                                oninput="updateCollageSettings()"></div>

                                        <!-- SECCIÓN DE COLOR -->
                                        <div>
                                            <label
                                                class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">Fondo
                                                del Collage</label>
                                            <div class="space-y-3">
                                                <div class="relative group cursor-pointer"
                                                    title="Clic para abrir paleta completa">
                                                    <input type="color" id="collage-bg" value="#ffffff"
                                                        class="w-full h-12 rounded-lg cursor-pointer border-2 border-slate-200 dark:border-slate-600 p-1 bg-white dark:bg-slate-700 hover:border-pink-300 transition-colors"
                                                        oninput="updateCollageSettings()">
                                                    <div
                                                        class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                        <span
                                                            class="text-xs font-bold text-slate-500 bg-white/80 px-2 py-1 rounded backdrop-blur-sm group-hover:text-pink-600">🎨
                                                            Toca para elegir color</span>
                                                    </div>
                                                </div>

                                                <div
                                                    class="flex flex-wrap gap-2 justify-center bg-slate-100 dark:bg-slate-700 p-2 rounded-lg">
                                                    <button onclick="setBg('#ffffff')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-white hover:scale-110 transition-transform ring-1 ring-slate-200"
                                                        title="Blanco"></button>
                                                    <button onclick="setBg('#000000')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-black hover:scale-110 transition-transform ring-1 ring-slate-200"
                                                        title="Negro"></button>
                                                    <button onclick="setBg('#f87171')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-red-400 hover:scale-110 transition-transform ring-1 ring-slate-200"></button>
                                                    <button onclick="setBg('#fbbf24')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-amber-400 hover:scale-110 transition-transform ring-1 ring-slate-200"></button>
                                                    <button onclick="setBg('#a3e635')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-lime-400 hover:scale-110 transition-transform ring-1 ring-slate-200"></button>
                                                    <button onclick="setBg('#22d3ee')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-cyan-400 hover:scale-110 transition-transform ring-1 ring-slate-200"></button>
                                                    <button onclick="setBg('#818cf8')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-indigo-400 hover:scale-110 transition-transform ring-1 ring-slate-200"></button>
                                                    <button onclick="setBg('#e879f9')"
                                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm bg-fuchsia-400 hover:scale-110 transition-transform ring-1 ring-slate-200"></button>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="resetCollage()"
                                        class="flex-1 py-3 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 font-medium transition-colors">Reiniciar</button>
                                    <button onclick="downloadCollage()"
                                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 shadow-lg shadow-pink-200 dark:shadow-none transition-all"><i
                                            data-lucide="download"></i> Guardar</button>
                                </div>
                            </div>
                            <div
                                class="w-full lg:w-2/3 bg-slate-200/50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-center p-4 min-h-[400px] relative overflow-auto">
                                <canvas id="collage-canvas" class="max-w-full shadow-xl bg-white"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. MARCA DE AGUA -->
        <section id="section-watermark" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-red-50/50 dark:bg-red-900/20 p-6 border-b border-red-100 dark:border-red-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_watermark_title"><i data-lucide="stamp"
                            class="text-red-600 dark:text-red-400"></i> Marca de Agua</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_watermark_desc">Estampa texto
                        o confidencialidad en tus
                        documentos.</p>
                </div>
                <div class="p-6">
                    <div id="watermark-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-watermark').click()">
                            <i data-lucide="file-text"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Selecciona tu PDF</p>
                            <input type="file" id="file-input-watermark" class="hidden" accept=".pdf">
                        </div>
                    </div>
                    <div id="watermark-workspace" class="hidden">
                        <div
                            class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Texto de
                                    la Marca</label>
                                <input type="text" id="wm-text" value="CONFIDENCIAL"
                                    class="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 mb-4">

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1">Color</label>
                                        <input type="color" id="wm-color" value="#ff0000"
                                            class="w-full h-10 rounded cursor-pointer">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1">Opacidad
                                            (0-1)</label>
                                        <input type="number" id="wm-opacity" value="0.5" step="0.1" min="0" max="1"
                                            class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600 dark:text-white">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1">Rotación
                                            (grados)</label>
                                        <input type="number" id="wm-rotation" value="45"
                                            class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1">Tamaño
                                            Fuente</label>
                                        <input type="number" id="wm-size" value="50"
                                            class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600 dark:text-white">
                                    </div>
                                </div>
                                <button onclick="resetWatermark()" class="text-red-500 underline text-sm">Cambiar
                                    PDF</button>
                            </div>
                        </div>
                        <button onclick="generateWatermark()"
                            class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 dark:shadow-none hover:bg-red-700 transition-colors">
                            Aplicar Marca de Agua
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 9. NÚMEROS DE PÁGINA -->
        <section id="section-pagenumbers" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-cyan-50/50 dark:bg-cyan-900/20 p-6 border-b border-cyan-100 dark:border-cyan-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_pagenum_title"><i data-lucide="hash"
                            class="text-cyan-600 dark:text-cyan-400"></i> Números de Página</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_pagenum_desc">Indica el orden
                        de tus páginas fácilmente.</p>
                </div>
                <div class="p-6">
                    <div id="pagenum-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-pagenum').click()">
                            <i data-lucide="file-plus"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Sube PDF para enumerar</p>
                            <input type="file" id="file-input-pagenum" class="hidden" accept=".pdf">
                        </div>
                    </div>
                    <div id="pagenum-workspace" class="hidden">
                        <div
                            class="flex flex-col sm:flex-row gap-6 mb-6 bg-slate-50 dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                            <div class="flex-1">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Posición</label>
                                <select id="pn-position"
                                    class="w-full p-2.5 rounded-lg border dark:bg-slate-900 dark:border-slate-600 dark:text-white">
                                    <option value="bottom-right">Abajo Derecha</option>
                                    <option value="bottom-center" selected>Abajo Centro</option>
                                    <option value="bottom-left">Abajo Izquierda</option>
                                    <option value="top-right">Arriba Derecha</option>
                                    <option value="top-center">Arriba Centro</option>
                                    <option value="top-left">Arriba Izquierda</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Formato</label>
                                <select id="pn-format"
                                    class="w-full p-2.5 rounded-lg border dark:bg-slate-900 dark:border-slate-600 dark:text-white">
                                    <option value="n">1</option>
                                    <option value="p-n">Página 1</option>
                                    <option value="n-of-total">1 de N</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="resetPageNum()"
                            class="text-sm text-red-500 mb-4 inline-block hover:underline">Cambiar archivo</button>
                        <button onclick="generatePageNum()"
                            class="w-full bg-cyan-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-cyan-200 dark:shadow-none hover:bg-cyan-700 transition-colors">
                            Insertar Números
                        </button>
                    </div>
                </div>
            </div>
        </section>



        <!-- 11. FIRMAR PDF -->
        <section id="section-sign" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-blue-50/50 dark:bg-blue-900/20 p-6 border-b border-blue-100 dark:border-blue-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_sign_title"><i data-lucide="pen-tool"
                            class="text-blue-600 dark:text-blue-400"></i> Firmar PDF</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_sign_desc">Crea tu firma y
                        arrástrala al documento.</p>
                </div>
                <div class="p-6">
                    <div id="sign-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-sign').click()">
                            <i data-lucide="pen-line"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Cargar PDF para firmar</p>
                            <input type="file" id="file-input-sign" class="hidden" accept=".pdf">
                        </div>
                    </div>

                    <div id="sign-workspace" class="hidden flex flex-col md:flex-row gap-6">
                        <!-- Columna Izquierda: Creador de Firma -->
                        <div class="w-full md:w-1/3 space-y-4">
                            <div
                                class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">

                                <!-- TABS Header -->
                                <div class="flex p-1 bg-slate-200 dark:bg-slate-900 rounded-lg mb-4">
                                    <button
                                        class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-slate-700 shadow text-slate-800 dark:text-slate-200 transition-all"
                                        id="tab-sign-draw" onclick="setSignTab('draw')">Dibujar</button>
                                    <button
                                        class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 transition-all"
                                        id="tab-sign-type" onclick="setSignTab('type')">Texto</button>
                                    <button
                                        class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 transition-all"
                                        id="tab-sign-upload" onclick="setSignTab('upload')">Subir</button>
                                </div>

                                <!-- TAB: DRAW -->
                                <div id="sign-content-draw">
                                    <div class="bg-white rounded border border-slate-200 cursor-crosshair relative touch-none"
                                        id="sig-pad-container">
                                        <canvas id="sig-canvas" width="300" height="150"
                                            class="w-full h-[150px]"></canvas>
                                        <div
                                            class="absolute bottom-2 right-2 text-xs text-slate-300 pointer-events-none">
                                            Dibujar aquí</div>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="clearSig()"
                                            class="flex-1 py-1 text-xs font-bold text-red-500 border border-red-200 rounded hover:bg-red-50">Borrar</button>
                                    </div>
                                </div>

                                <!-- TAB: TYPE -->
                                <div id="sign-content-type" class="hidden space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Nombre o
                                            Iniciales</label>
                                        <input type="text" id="sign-text-input" placeholder="Tu Nombre"
                                            class="w-full p-2 text-sm border rounded bg-white dark:bg-slate-900 dark:border-slate-600 dark:text-white"
                                            oninput="renderTypePreviews()">
                                    </div>

                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Color</label>
                                        <div class="flex gap-2">
                                            <button onclick="setSignColor('#000000')"
                                                class="w-6 h-6 rounded-full bg-black border border-slate-200 ring-2 ring-offset-1 ring-transparent hover:ring-slate-300 focus:ring-blue-500"></button>
                                            <button onclick="setSignColor('#dc2626')"
                                                class="w-6 h-6 rounded-full bg-red-600 border border-slate-200 ring-2 ring-offset-1 ring-transparent hover:ring-slate-300 focus:ring-blue-500"></button>
                                            <button onclick="setSignColor('#2563eb')"
                                                class="w-6 h-6 rounded-full bg-blue-600 border border-slate-200 ring-2 ring-offset-1 ring-transparent hover:ring-slate-300 focus:ring-blue-500"></button>
                                            <button onclick="setSignColor('#16a34a')"
                                                class="w-6 h-6 rounded-full bg-green-600 border border-slate-200 ring-2 ring-offset-1 ring-transparent hover:ring-slate-300 focus:ring-blue-500"></button>
                                        </div>
                                        <input type="hidden" id="sign-color-val" value="#000000">
                                    </div>

                                    <div class="space-y-2 max-h-[200px] overflow-y-auto pr-1" id="type-previews">
                                        <!-- Previews generated by JS -->
                                    </div>
                                </div>

                                <!-- TAB: UPLOAD -->
                                <div id="sign-content-upload" class="hidden">
                                    <div
                                        class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg p-6 text-center hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors cursor-pointer relative">
                                        <input type="file" id="sign-upload-input"
                                            class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*"
                                            onchange="handleSignUpload(this)">
                                        <div id="sign-upload-preview" class="flex flex-col items-center justify-center">
                                            <i data-lucide="image-up" class="w-8 h-8 text-slate-400 mb-2"></i>
                                            <p class="text-xs text-slate-500">Clic o arrastra imagen</p>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="saveSig()"
                                    class="w-full mt-4 bg-teal-600 text-white py-2 rounded-lg font-bold shadow hover:bg-teal-700 transition-colors">
                                    <i data-lucide="check" class="inline w-4 h-4 mr-1"></i> Generar Firma
                                </button>
                            </div>

                            <div id="sig-actions" class="hidden space-y-4 animate-fade-in">
                                <div
                                    class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-xs rounded-lg">
                                    <strong><i data-lucide="info" class="inline w-3 h-3"></i> Listo:</strong>
                                    Haz clic en la página donde quieres estampar la firma.
                                </div>
                                <button onclick="downloadSignedPDF()"
                                    class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none hover:bg-blue-700 transition-colors">
                                    <i data-lucide="download" class="inline w-4 h-4 mr-1"></i> Descargar Firmado
                                </button>
                                <button onclick="resetSign()" class="w-full py-2 text-slate-400 text-sm">Empezar de
                                    nuevo</button>
                            </div>
                        </div>

                        <!-- Columna Derecha: Vista Previa PDF -->
                        <div
                            class="w-full md:w-2/3 bg-slate-200/50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex flex-col items-center p-4 min-h-[500px] relative">
                            <div class="flex items-center gap-4 mb-2">
                                <button onclick="prevSignPage()" class="p-1 bg-white rounded shadow text-slate-600"><i
                                        data-lucide="arrow-left" class="w-4 h-4"></i></button>
                                <span id="sign-page-indicator"
                                    class="font-bold text-sm text-slate-600 dark:text-slate-300">Pág 1</span>
                                <button onclick="nextSignPage()" class="p-1 bg-white rounded shadow text-slate-600"><i
                                        data-lucide="arrow-right" class="w-4 h-4"></i></button>
                            </div>
                            <div class="relative shadow-xl overflow-hidden group cursor-pointer" id="sign-pdf-container"
                                onclick="placeSignatureOnPage(event)">
                                <canvas id="sign-pdf-canvas" class="max-w-full"></canvas>
                                <!-- Marcador de firma fantasma -->
                                <div id="sig-ghost"
                                    class="absolute pointer-events-none hidden border-2 border-dashed border-blue-500 bg-blue-500/10 transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 13. OCR -->
        <section id="section-ocr" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div
                    class="bg-yellow-50/50 dark:bg-yellow-900/20 p-6 border-b border-yellow-100 dark:border-yellow-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_ocr_title"><i data-lucide="text-select"
                            class="text-yellow-600 dark:text-yellow-400"></i> OCR / Texto
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_ocr_desc">Extrae texto
                        editable de imágenes o PDFs
                        escaneados.</p>
                </div>
                <div class="p-6">
                    <div id="ocr-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-ocr').click()">
                            <i data-lucide="image-plus"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Sube Imagen o PDF</p>
                            <input type="file" id="file-input-ocr" class="hidden"
                                accept="image/*,.pdf,.heic,.heif,.webp">
                        </div>
                    </div>
                    <div id="ocr-workspace" class="hidden">
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="w-full md:w-1/2 space-y-4">
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm">Configuración
                                    </h3>
                                    <label
                                        class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Idioma</label>
                                    <select id="ocr-lang"
                                        class="config-select w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 text-sm focus:ring-2 focus:ring-yellow-500 outline-none">
                                        <option value="spa">Español</option>
                                        <option value="eng">Inglés</option>
                                        <option value="fra">Francés</option>
                                        <option value="deu">Alemán</option>
                                        <option value="por">Portugués</option>
                                        <option value="ita">Italiano</option>
                                    </select>
                                    <button onclick="startOCR()"
                                        class="w-full mt-4 bg-yellow-600 text-white py-2 rounded-lg font-bold shadow hover:bg-yellow-700 transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="scan-text" class="w-4 h-4"></i> Iniciar OCR
                                    </button>
                                </div>
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm">Vista Previa
                                    </h3>
                                    <div
                                        class="aspect-video bg-slate-200 dark:bg-slate-700 rounded-lg overflow-hidden flex items-center justify-center">
                                        <img id="ocr-preview-img" class="max-w-full max-h-full object-contain">
                                    </div>
                                </div>
                                <button onclick="resetOCR()"
                                    class="w-full py-2 text-slate-500 dark:text-slate-400 hover:text-red-500 font-medium text-sm border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Elegir
                                    otro archivo</button>
                            </div>
                            <div class="w-full md:w-1/2 space-y-4">
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm">Texto
                                        Extraído</h3>
                                    <textarea id="ocr-result-text" rows="10"
                                        class="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 text-sm focus:ring-2 focus:ring-yellow-500 outline-none"
                                        placeholder="El texto reconocido aparecerá aquí..."></textarea>
                                    <div class="flex gap-2 mt-4">
                                        <button onclick="copyOCRText()"
                                            class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                            <i data-lucide="copy" class="w-4 h-4"></i> Copiar
                                        </button>
                                        <button onclick="downloadOCRText()"
                                            class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold shadow hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                            <i data-lucide="download" class="w-4 h-4"></i> Descargar TXT
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 14. SCAN ENHANCER -->
        <section id="section-scan-enhancer" class="hidden animate-fade-in">
            <div
                class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                <div class="bg-gray-50/50 dark:bg-gray-900/20 p-6 border-b border-gray-100 dark:border-gray-900/50">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"
                        data-i18n="sect_scan_title"><i data-lucide="wand-2"
                            class="text-gray-600 dark:text-gray-400"></i> Mejorar Escaneo
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm" data-i18n="sect_scan_desc">Limpia y binariza
                        imágenes de documentos para
                        mejorar la legibilidad.</p>
                </div>
                <div class="p-6">
                    <div id="scan-upload-area">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-10 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                            onclick="document.getElementById('file-input-scan').click()">
                            <i data-lucide="image-plus"
                                class="w-10 h-10 text-slate-400 dark:text-slate-500 mx-auto mb-3"></i>
                            <p class="font-medium text-slate-700 dark:text-slate-300">Sube una imagen de documento</p>
                            <input type="file" id="file-input-scan" class="hidden" accept="image/*,.heic,.heif,.webp">
                        </div>
                    </div>
                    <div id="scan-workspace" class="hidden">
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="w-full md:w-1/3 space-y-4">
                                <div
                                    class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm">Ajustes</h3>
                                    <div>
                                        <label
                                            class="flex justify-between text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1"><span>Umbral
                                                (Binarización)</span><span id="scan-threshold-val">160</span></label>
                                        <input type="range" id="scan-threshold" min="0" max="255" value="160"
                                            class="w-full accent-gray-600" oninput="updateScanPreview()">
                                    </div>
                                    <button onclick="resetScan()"
                                        class="w-full mt-4 py-2 text-slate-500 dark:text-slate-400 hover:text-red-500 font-medium text-sm border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Elegir
                                        otra imagen</button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="downloadScan('jpg')"
                                        class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i> Descargar JPG
                                    </button>
                                    <button onclick="downloadScan('pdf')"
                                        class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-200 dark:shadow-none hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4"></i> Descargar PDF
                                    </button>
                                </div>
                            </div>
                            <div
                                class="w-full md:w-2/3 bg-slate-200/50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-center p-4 min-h-[400px] relative overflow-auto">
                                <canvas id="scan-canvas" class="max-w-full shadow-xl bg-white"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- FOOTER AGREGADO -->
    <footer
        class="bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 py-8 mt-auto transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-600 dark:text-slate-400 font-medium">
                &copy; <span id="current-year"></span> <span data-i18n="footer_rights">Todos los derechos
                    reservados.</span>
            </p>
            <p class="text-slate-500 dark:text-slate-500 text-sm mt-2">
                <span data-i18n="footer_author">Autor:</span> <span
                    class="font-bold text-blue-600 dark:text-blue-400">Erwin Marte</span>
            </p>
        </div>
    </footer>

    <!-- Modal Status -->
    <div id="status-modal"
        class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[60] backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center transition-colors">
            <div id="loader-ui" class="flex flex-col items-center">
                <div class="loader mb-4"></div>
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">Procesando...</h3>
                <p id="status-text" class="text-slate-500 dark:text-slate-400 text-sm mt-1">Por favor espera</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // ==========================================
        // MODO OSCURO & IDIOMA & FOOTER
        // ==========================================
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Dark Mode Logic
        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        // Language Logic
        let currentLang = localStorage.getItem('lang') || 'es';

        const translations = {
            es: {
                nav_home: "Inicio",
                nav_compress: "Comprimir",
                nav_img2pdf: "Img a PDF",
                nav_nup: "Resumir",
                nav_split: "Dividir",
                nav_merge: "Unir",
                nav_pdf2img: "PDF a Img",
                nav_all: "Todas",

                hero_title: "Suite de Herramientas <span class='text-blue-600 dark:text-blue-400'>PDF</span>",
                hero_desc: "Todas las herramientas que necesitas en un solo lugar. 100% Privado y seguro en tu navegador.",

                // Cards
                card_img2pdf_title: "Img a PDF",
                card_img2pdf_desc: "Convierte fotos a PDF.",
                card_compress_title: "Comprimir PDF",
                card_compress_desc: "Reduce el tamaño del archivo.",
                card_nup_title: "Resumir PDF",
                card_nup_desc: "Varias páginas en una.",
                card_split_title: "Dividir / Rotar",
                card_split_desc: "Elimina o rota páginas.",
                card_merge_title: "Unir PDFs",
                card_merge_desc: "Combina múltiples archivos.",
                card_pdf2img_title: "PDF a Imágenes",
                card_pdf2img_desc: "Extrae páginas como JPG.",
                card_ocr_title: "OCR / Texto",
                card_ocr_desc: "Extrae texto editable de imágenes.",
                card_scan_title: "Mejorar Escaneo",
                card_scan_desc: "Limpia y binariza fotos de documentos.",
                card_poster_title: "Póster Gigante",
                card_poster_desc: "Imprime en múltiples A4.",
                card_collage_title: "Estudio Collage",
                card_collage_desc: "Crea composiciones.",
                card_watermark_title: "Marca de Agua",
                card_watermark_desc: "Pon tu sello en todas las páginas.",
                card_pagenum_title: "Números de Pág",
                card_pagenum_desc: "Añade numeración auto.",
                card_sign_title: "Firmar PDF",
                card_sign_desc: "Dibuja y coloca tu firma.",

                // Sections Headers
                sect_compress_title: "Comprimir PDF",
                sect_compress_desc: "Reduce el tamaño de tu archivo PDF.",

                sect_img2pdf_title: "Imagen a PDF",
                sect_img2pdf_desc: "Convierte tus imágenes con opciones de personalización profesionales.",

                sect_nup_title: "Resumir PDF",
                sect_nup_desc: "Junta varias páginas en una sola para ahorrar impresión.",

                sect_split_title: "Editor de Páginas",
                sect_split_desc: "Arrastra para reordenar, elimina páginas o gíralas.",

                sect_merge_title: "Unir PDFs",
                sect_merge_desc: "Combina múltiples documentos en uno solo. Arrastra para ordenar.",

                sect_pdf2img_title: "PDF a Imágenes",
                sect_pdf2img_desc: "Convierte cada página de tu PDF en una imagen JPG de alta calidad.",

                sect_ocr_title: "Reconocimiento de Texto (OCR)",
                sect_ocr_desc: "Extrae texto de imágenes escaneadas o PDFs.",

                sect_scan_title: "Mejorador de Escaneos",
                sect_scan_desc: "Optimiza fotos de documentos para impresión (Fondo blanco, texto nítido).",

                sect_poster_title: "Creador de Pósters",
                sect_poster_desc: "Imprime una imagen grande en varias hojas A4.",

                sect_collage_title: "Estudio de Collage",
                sect_collage_desc: "Combina fotos en diseños predefinidos.",

                sect_watermark_title: "Marca de Agua",
                sect_watermark_desc: "Agrega texto superpuesto a tu documento.",

                sect_pagenum_title: "Numeración de Páginas",
                sect_pagenum_desc: "Añade números de página a tu documento.",

                sect_sign_title: "Firmar PDF",
                sect_sign_desc: "Dibuja tu firma, escribe texto o sube una imagen y colócala en el PDF.",

                // Dropdown
                drop_organize: "Organizar",
                drop_convert: "Convertir",
                drop_edit: "Editar",
                drop_others: "Otros",

                // Dropdown Tools
                drop_merge: "Unir PDF",
                drop_compress: "Comprimir",
                drop_split: "Dividir PDF",
                drop_nup: "Resumir PDF",
                drop_img2pdf: "Img a PDF",
                drop_pdf2img: "PDF a Img",
                drop_ocr: "OCR / Texto",
                drop_scan: "Mejorar Escaneo",
                drop_watermark: "Marca Agua",
                drop_pagenum: "Números Pág",
                drop_sign: "Firmar PDF",
                drop_poster: "Póster",
                drop_collage: "Collage",

                // Footer
                footer_rights: "Todos los derechos reservados.",
                footer_author: "Autor:"
            },
            en: {
                nav_home: "Home",
                nav_compress: "Compress",
                nav_img2pdf: "Img to PDF",
                nav_nup: "N-Up",
                nav_split: "Split",
                nav_merge: "Merge",
                nav_pdf2img: "PDF to Img",
                nav_all: "All Tools",

                hero_title: "PDF <span class='text-blue-600 dark:text-blue-400'>Master</span> Suite",
                hero_desc: "All the tools you need in one place. 100% Private and secure in your browser.",

                card_img2pdf_title: "Img to PDF",
                card_img2pdf_desc: "Convert photos to PDF.",
                card_compress_title: "Compress PDF",
                card_compress_desc: "Reduce file size.",
                card_nup_title: "N-Up PDF",
                card_nup_desc: "Multiple pages per sheet.",
                card_split_title: "Split / Rotate",
                card_split_desc: "Delete or rotate pages.",
                card_merge_title: "Merge PDFs",
                card_merge_desc: "Combine multiple files.",
                card_pdf2img_title: "PDF to Images",
                card_pdf2img_desc: "Extract pages as JPG.",
                card_ocr_title: "OCR / Text",
                card_ocr_desc: "Extract editable text.",
                card_scan_title: "Scan Enhancer",
                card_scan_desc: "Clean and binarize docs.",
                card_poster_title: "Giant Poster",
                card_poster_desc: "Print on multiple A4s.",
                card_collage_title: "Collage Studio",
                card_collage_desc: "Create compositions.",
                card_watermark_title: "Watermark",
                card_watermark_desc: "Stamp all pages.",
                card_pagenum_title: "Page Numbers",
                card_pagenum_desc: "Add auto numbering.",
                card_sign_title: "Sign PDF",
                card_sign_desc: "Draw and place signature.",

                sect_compress_title: "Compress PDF",
                sect_compress_desc: "Reduce your PDF file size.",

                sect_img2pdf_title: "Image to PDF",
                sect_img2pdf_desc: "Convert your images with professional options.",

                sect_nup_title: "N-Up (Summarize)",
                sect_nup_desc: "Put multiple pages on one sheet to save paper.",

                sect_split_title: "Page Editor",
                sect_split_desc: "Drag to reorder, delete pages or rotate them.",

                sect_merge_title: "Merge PDFs",
                sect_merge_desc: "Combine multiple documents into one. Drag to sort.",

                sect_pdf2img_title: "PDF to Images",
                sect_pdf2img_desc: "Convert each PDF page to a high-quality JPG image.",

                sect_ocr_title: "Text Recognition (OCR)",
                sect_ocr_desc: "Extract text from scanned images or PDFs.",

                sect_scan_title: "Scan Enhancer",
                sect_scan_desc: "Optimize document photos (White background, sharp text).",

                sect_poster_title: "Poster Creator",
                sect_poster_desc: "Print a large image across multiple A4 sheets.",

                sect_collage_title: "Collage Studio",
                sect_collage_desc: "Combine photos into predefined layouts.",

                sect_watermark_title: "Watermark",
                sect_watermark_desc: "Add overlay text to your document.",

                sect_pagenum_title: "Page Numbers",
                sect_pagenum_desc: "Add page numbers to your document.",

                sect_sign_title: "Sign PDF",
                sect_sign_desc: "Draw your signature, type text or upload an image and place it on the PDF.",

                drop_organize: "Organize",
                drop_convert: "Convert",
                drop_edit: "Edit",
                drop_others: "Others",

                drop_merge: "Merge PDF",
                drop_compress: "Compress",
                drop_split: "Split PDF",
                drop_nup: "N-Up PDF",
                drop_img2pdf: "Img to PDF",
                drop_pdf2img: "PDF to Img",
                drop_ocr: "OCR / Text",
                drop_scan: "Scan Enhancer",
                drop_watermark: "Watermark",
                drop_pagenum: "Page Numbers",
                drop_sign: "Sign PDF",
                drop_poster: "Poster",
                drop_collage: "Collage",

                footer_rights: "All rights reserved.",
                footer_author: "Author:"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'es' ? 'en' : 'es';
            localStorage.setItem('lang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            document.documentElement.lang = currentLang;
            document.getElementById('lang-btn-text').textContent = currentLang.toUpperCase();

            const t = translations[currentLang];

            // Apply to all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT' && el.type === 'placeholder') {
                        el.placeholder = t[key];
                    } else if (key === 'hero_title') {
                        el.innerHTML = t[key]; // Special case for HTML content
                    } else if (el.childNodes.length > 0) {
                        // Try to preserve icons if they are creating children. 
                        // Strategy: Update text node only if mixed content? 
                        // For simplicity in this project's structure, standard replacement is mostly fine
                        // BUT for buttons with icons, we need to be careful.
                        // Let's check if there is a direct text node to replace or innerHTML.

                        // Simple approach: if element has specific structure constraint, handle manually
                        // Else, just innerHTML or textContent.

                        // For tool buttons (icon + text), we'll wrap text in span or just rebuild.
                        // Let's look at nav buttons: <i data-lucide...></i> Text
                        // We should wrap the text in a span or just replace the last child if it's text.

                        let icon = el.querySelector('i') || el.querySelector('svg');
                        if (icon) {
                            // Preserve icon
                            const iconHtml = icon.outerHTML;
                            el.innerHTML = iconHtml + ' ' + t[key];
                            lucide.createIcons(); // Re-init icons just in case
                        } else {
                            el.innerHTML = t[key];
                        }
                    } else {
                        el.textContent = t[key];
                    }
                }
            });
        }

        // Init Load
        applyLanguage();



        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
            setTimeout(lucide.createIcons, 50);
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // ==========================================
        // FUNCIONES DE HERRAMIENTAS & UTILIDADES
        // ==========================================

        function switchTool(tool) {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            });
            const navBtn = document.getElementById(`nav-${tool}`);
            if (navBtn) {
                navBtn.classList.add('active');
                navBtn.classList.remove('inactive');
            }
            ['home', 'img2pdf', 'split', 'merge', 'poster', 'collage', 'pdf2img', 'nup', 'watermark', 'pagenumbers', 'sign', 'compress', 'ocr', 'scan-enhancer'].forEach(s => {
                const sec = document.getElementById(`section-${s}`);
                if (sec) sec.classList.add('hidden');
            });
            const activeSec = document.getElementById(`section-${tool}`);
            if (activeSec) activeSec.classList.remove('hidden');
        }

        const showLoader = (msg) => { document.getElementById('status-text').innerText = msg; document.getElementById('status-modal').classList.remove('hidden'); };
        const hideLoader = () => document.getElementById('status-modal').classList.add('hidden');
        function blobToDataURL(b) { return new Promise((r, j) => { const x = new FileReader(); x.onload = e => r(e.target.result); x.onerror = j; x.readAsDataURL(b); }); }
        function loadImage(s) { return new Promise((r, j) => { const i = new Image(); i.onload = () => r(i); i.onerror = j; i.src = s; }); }

        // =======================================================
        // HELPER PARA SORTABLE (DRAG & DROP)
        // =======================================================
        function enableDragSort(containerId, dataArray, callbackUpdate) {
            const el = document.getElementById(containerId);
            new Sortable(el, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                delay: 100, // Pequeño delay para evitar arrastres accidentales en móvil
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    // Reordenar el array de datos basado en el nuevo orden del DOM
                    const newOrderIds = Array.from(el.children).map(child => child.getAttribute('data-id'));

                    // Crear un mapa temporal para acceso rápido
                    const tempMap = new Map(dataArray.map(item => [item.id.toString(), item]));

                    // Reconstruir el array en el nuevo orden
                    // NOTA: Modificamos el array original in-place
                    dataArray.length = 0;
                    newOrderIds.forEach(id => {
                        if (tempMap.has(id)) dataArray.push(tempMap.get(id));
                    });

                    // Callback opcional si se necesita actualizar algo más (ej: contadores)
                    if (callbackUpdate) callbackUpdate();
                }
            });
        }

        // ==========================================
        // 1. IMAGEN A PDF (ACTUALIZADO: LOGICA TIPO FREEPDFCONVERT)
        // ==========================================
        let imgFiles = []; let imgMode = 'standard';

        function setImgMode(mode) {
            imgMode = mode;
            const stdBtn = document.getElementById('tab-std');
            const dupBtn = document.getElementById('tab-dup');
            const dupInfo = document.getElementById('duplicate-info');
            const stdOptions = document.getElementById('standard-options'); // Panel de nuevas opciones

            const baseClass = 'flex-1 py-3 text-sm font-medium border-b-2 transition-colors duration-300';
            const activeClass = 'border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400 bg-blue-50/30 dark:bg-blue-900/20';
            const inactiveClass = 'border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200';

            if (mode === 'standard') {
                stdBtn.className = `${baseClass} ${activeClass}`;
                dupBtn.className = `${baseClass} ${inactiveClass}`;
                // dupInfo.classList.add('hidden'); // Ocultamos la info antigua
                stdOptions.classList.remove('hidden');
            } else {
                stdBtn.className = `${baseClass} ${inactiveClass}`;
                dupBtn.className = `${baseClass} ${activeClass}`;
                // dupInfo.classList.remove('hidden'); // Ya no mostramos el mensaje de "ignora configs"
                stdOptions.classList.remove('hidden'); // AHORA MOSTRAMOS OPCIONES EN DUPLICATE TAMBIÉN
            }
            renderImg2PdfPreview(); // Actualizar preview al cambiar modo
        }

        document.getElementById('file-input-img').addEventListener('change', async (e) => { await handleImgFiles(e.target.files); });

        async function handleImgFiles(files) {
            showLoader("Procesando...");
            for (const file of Array.from(files)) {
                try {
                    let dataUrl;
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'pdf') {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i); const vp = page.getViewport({ scale: 2 }); const c = document.createElement('canvas'); c.width = vp.width; c.height = vp.height; await page.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
                            imgFiles.push({ id: Math.random(), data: c.toDataURL('image/jpeg', 0.8), w: vp.width, h: vp.height, rotation: 0 });
                        }
                        continue;
                    } else if (['heic', 'heif'].includes(ext)) { dataUrl = await blobToDataURL(await heic2any({ blob: file, toType: "image/jpeg" })); }
                    else if (['tiff', 'tif'].includes(ext)) { const ab = await file.arrayBuffer(); const ifds = UTIF.decode(ab); UTIF.decodeImage(ab, ifds[0]); const rgba = UTIF.toRGBA8(ifds[0]); const c = document.createElement("canvas"); c.width = ifds[0].width; c.height = ifds[0].height; const ctx = c.getContext("2d"); const d = ctx.createImageData(c.width, c.height); for (let i = 0; i < rgba.length; i++) d.data[i] = rgba[i]; ctx.putImageData(d, 0, 0); dataUrl = c.toDataURL("image/jpeg", 0.9); }
                    else { dataUrl = await blobToDataURL(file); }
                    const i = await loadImage(dataUrl);
                    imgFiles.push({ id: Math.random(), data: dataUrl, w: i.width, h: i.height, rotation: 0 });
                } catch (e) { console.error(e); }
            }
            hideLoader(); renderImgGrid(); document.getElementById('file-input-img').value = '';
        }

        function renderImgGrid() {
            const g = document.getElementById('img-grid');
            g.innerHTML = '';

            imgFiles.forEach((f, i) => {
                g.innerHTML += `
                <div class="relative group bg-slate-100 dark:bg-slate-800 rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm transition-all hover:shadow-md cursor-grab active:cursor-grabbing" data-id="${f.id}">
                    <!-- Contenedor Imagen -->
                    <div class="aspect-square flex items-center justify-center p-2 bg-slate-200/50 dark:bg-slate-900/50 overflow-hidden pointer-events-none">
                        <img src="${f.data}" class="object-contain max-w-full max-h-full transition-transform duration-300" style="transform: rotate(${f.rotation}deg)">
                    </div>
                    
                    <!-- Overlay Controles -->
                    <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center gap-2 transition-opacity backdrop-blur-[1px] p-2">
                        <div class="text-white text-xs font-bold mb-2"><i data-lucide="move" class="inline w-4 h-4"></i> Arrastrar</div>
                        
                        <!-- Botones Acción -->
                        <div class="flex gap-2 mt-2">
                            <button onclick="rotImg(${i})" class="w-10 h-10 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg transition-transform hover:scale-110" title="Rotar 90º">
                                <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                            </button>
                            <button onclick="rmImg(${i})" class="w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-transform hover:scale-110" title="Eliminar">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Badge Número -->
                    <div class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full font-bold shadow-sm pointer-events-none border border-white/20">
                        ${i + 1}
                    </div>
                </div>`;
            });

            document.getElementById('btn-gen-img').classList.toggle('hidden', imgFiles.length === 0);
            lucide.createIcons();

            // ACTIVAR DRAG & DROP
            enableDragSort('img-grid', imgFiles, () => {
                // Actualizar números visuales después de soltar
                document.querySelectorAll('#img-grid > div').forEach((div, idx) => {
                    div.querySelector('.absolute.top-2').innerText = idx + 1;
                });
            });
        }

        function rmImg(i) { imgFiles.splice(i, 1); renderImgGrid(); }
        function rotImg(i) { imgFiles[i].rotation = (imgFiles[i].rotation + 90) % 360; renderImgGrid(); }

        function getRotatedImage(url, rotation) {
            return new Promise((resolve) => {
                const image = new Image();
                image.onload = () => {
                    if (rotation === 0) {
                        resolve({ data: url, w: image.width, h: image.height });
                        return;
                    }
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const rads = rotation * Math.PI / 180;
                    const sin = Math.abs(Math.sin(rads));
                    const cos = Math.abs(Math.cos(rads));
                    canvas.width = image.width * cos + image.height * sin;
                    canvas.height = image.width * sin + image.height * cos;
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(rads);
                    ctx.drawImage(image, -image.width / 2, -image.height / 2);
                    resolve({ data: canvas.toDataURL('image/jpeg', 0.9), w: canvas.width, h: canvas.height });
                };
                image.src = url;
            });
        }

        // ==========================================
        // LÓGICA DE GENERACIÓN MEJORADA (TIPO FREEPDFCONVERT)
        // ==========================================
        // ==========================================
        // PREVIEW logic
        // ==========================================
        function togglePreviewImg2Pdf() {
            const area = document.getElementById('img2pdf-preview-area');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                renderImg2PdfPreview();
            } else {
                area.classList.add('hidden');
            }
        }

        async function renderImg2PdfPreview() {
            const area = document.getElementById('img2pdf-preview-area');
            // If hidden, do nothing unless we force? No, save resources.
            if (area.classList.contains('hidden')) return;

            if (imgFiles.length === 0) {
                const cvs = document.getElementById('img2pdf-preview-canvas');
                cvs.width = 300; cvs.height = 150;
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = '#f1f5f9'; ctx.fillRect(0, 0, cvs.width, cvs.height);
                ctx.fillStyle = '#94a3b8'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText("Sube una imagen para previsualizar", cvs.width / 2, cvs.height / 2);
                return;
            }

            const imgFile = imgFiles[0];
            const imgObj = await loadImage(imgFile.data);

            const cvs = document.getElementById('img2pdf-preview-canvas');
            const ctx = cvs.getContext('2d');

            const pageSizeOpt = document.getElementById('img-page-size').value;
            const orientOpt = document.getElementById('img-orientation').value;
            const marginOpt = document.getElementById('img-margin').value;

            // Dimensions in mm
            const sizes = {
                'a0': { w: 841, h: 1189 }, 'a1': { w: 594, h: 841 }, 'a2': { w: 420, h: 594 },
                'a3': { w: 297, h: 420 }, 'a4': { w: 210, h: 297 }, 'a5': { w: 148.5, h: 210 },
                'a6': { w: 105, h: 148.5 }, 'a7': { w: 74, h: 105 }, 'a8': { w: 52, h: 74 },
                'a9': { w: 37, h: 52 }, 'a10': { w: 26, h: 37 },
                'letter': { w: 215.9, h: 279.4 }, 'legal': { w: 215.9, h: 355.6 }
            };

            let pageW, pageH;

            // Determine Page Dimensions (mm)
            if (pageSizeOpt === 'fit') {
                if (imgMode === 'duplicate') {
                    // Auto-fallback to A4 if fit selected in duplicate
                    pageW = 210; pageH = 297;
                } else {
                    pageW = imgObj.width * 0.264583;
                    pageH = imgObj.height * 0.264583;
                }
            } else {
                const s = sizes[pageSizeOpt] || sizes['a4'];
                pageW = s.w; pageH = s.h;
            }

            // Determine Orientation
            let finalOrient = 'p';
            if (orientOpt === 'auto') {
                if (imgMode === 'standard') {
                    finalOrient = (imgObj.width > imgObj.height) ? 'l' : 'p';
                } else {
                    // DUPLICATE AUTO LOGIC
                    const pScale = Math.min(Math.min(pageW, pageH) / imgObj.width, (Math.max(pageW, pageH) / 2) / imgObj.height);
                    const lScale = Math.min((Math.max(pageW, pageH) / 2) / imgObj.width, Math.min(pageW, pageH) / imgObj.height);
                    finalOrient = (lScale > pScale) ? 'l' : 'p';
                }
            } else {
                finalOrient = orientOpt;
            }

            // Swap page dimensions if landscape
            let displayW, displayH;
            if (finalOrient === 'l') {
                displayW = Math.max(pageW, pageH);
                displayH = Math.min(pageW, pageH);
            } else {
                displayW = Math.min(pageW, pageH);
                displayH = Math.max(pageW, pageH);
            }

            // Canvas Setup (Scale to fit max 500px height or width)
            const scaleFactor = 500 / displayH;
            cvs.height = 500;
            cvs.width = displayW * scaleFactor;

            // Draw Page Background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, cvs.width, cvs.height);
            ctx.strokeStyle = '#cbd5e1';
            ctx.strokeRect(0, 0, cvs.width, cvs.height);

            // Draw Content
            let margin = 0;
            if (marginOpt === 'small') margin = 10;
            if (marginOpt === 'normal') margin = 20;
            margin *= scaleFactor; // Convert mm to px

            if (imgMode === 'standard') {
                const drawAreaW = cvs.width - (margin * 2);
                const drawAreaH = cvs.height - (margin * 2);
                drawContain(ctx, imgObj, margin, margin, drawAreaW, drawAreaH);
            } else {
                // DUPLICATE DRAW
                const isLand = displayW > displayH;

                let boxW, boxH, box1X, box1Y, box2X, box2Y;
                let cutX1, cutY1, cutX2, cutY2;

                if (isLand) {
                    // Landscape Page: Side by Side
                    boxW = cvs.width / 2;
                    boxH = cvs.height;

                    const innerBoxW = boxW - (margin * 2);
                    const innerBoxH = boxH - (margin * 2);

                    drawContain(ctx, imgObj, margin, margin, innerBoxW, innerBoxH);
                    drawContain(ctx, imgObj, boxW + margin, margin, innerBoxW, innerBoxH);

                    cutX1 = boxW; cutY1 = 10; cutX2 = boxW; cutY2 = cvs.height - 10;

                } else {
                    // Portrait Page: Vertical Stack
                    boxW = cvs.width;
                    boxH = cvs.height / 2;

                    const innerBoxW = boxW - (margin * 2);
                    const innerBoxH = boxH - (margin * 2);

                    drawContain(ctx, imgObj, margin, margin, innerBoxW, innerBoxH);
                    drawContain(ctx, imgObj, margin, boxH + margin, innerBoxW, innerBoxH);

                    cutX1 = 10; cutY1 = boxH; cutX2 = cvs.width - 10; cutY2 = boxH;
                }

                // Draw Cut Line
                ctx.strokeStyle = '#94a3b8';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(cutX1, cutY1);
                ctx.lineTo(cutX2, cutY2);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        async function generateImgPDF() {
            if (!imgFiles.length) return;
            showLoader("Generando PDF...");
            await new Promise(r => setTimeout(r, 100));

            const { jsPDF } = window.jspdf;

            // Obtener configuraciones del usuario
            const pageSizeOpt = document.getElementById('img-page-size').value; // a4, letter, fit...
            const orientOpt = document.getElementById('img-orientation').value; // auto, p, l
            const marginOpt = document.getElementById('img-margin').value; // none, small, normal
            const separateFiles = document.getElementById('img-separate-files').checked;

            const sizes = {
                'a0': { w: 841, h: 1189 }, 'a1': { w: 594, h: 841 }, 'a2': { w: 420, h: 594 },
                'a3': { w: 297, h: 420 }, 'a4': { w: 210, h: 297 }, 'a5': { w: 148.5, h: 210 },
                'a6': { w: 105, h: 148.5 }, 'a7': { w: 74, h: 105 }, 'a8': { w: 52, h: 74 },
                'letter': { w: 215.9, h: 279.4 }, 'legal': { w: 215.9, h: 355.6 }
            };

            // Definir márgenes (en mm)
            let marginVal = 0;
            if (marginOpt === 'small') marginVal = 10;
            if (marginOpt === 'normal') marginVal = 20;

            let zip = null;
            if (separateFiles && imgMode === 'standard') zip = new JSZip();

            let doc = null;
            if (!separateFiles || imgMode === 'duplicate') {
                doc = new jsPDF({ format: 'a4', unit: 'mm' }); // Default init
                doc.deletePage(1);
            }

            for (let i = 0; i < imgFiles.length; i++) {
                const rotatedImg = await getRotatedImage(imgFiles[i].data, imgFiles[i].rotation);
                const imgData = rotatedImg.data;
                const imgW = rotatedImg.w;
                const imgH = rotatedImg.h;
                const ratio = imgW / imgH;

                let currentDoc = doc;
                if (separateFiles && imgMode === 'standard') {
                    currentDoc = new jsPDF({ format: 'a4', unit: 'mm' });
                    currentDoc.deletePage(1);
                }

                // Determine Page Size & Orientation logic (Shared)
                let pageW, pageH, orientation;

                if (pageSizeOpt === 'fit') {
                    if (imgMode === 'duplicate') {
                        // Fallback for duplicate fit -> A4 (Standard)
                        const s = sizes['a4'];
                        pageW = s.w; pageH = s.h; // Default portrait basis
                    } else {
                        pageW = imgW * 0.264583; pageH = imgH * 0.264583;
                        if (marginOpt === 'none') marginVal = 0;
                    }
                } else {
                    const s = sizes[pageSizeOpt] || sizes['a4'];
                    pageW = s.w; pageH = s.h;
                }

                // Orientation Optimization
                if (orientOpt === 'auto') {
                    if (imgMode === 'standard') {
                        orientation = ratio > 1 ? 'l' : 'p';
                    } else {
                        // Duplicate Optimization
                        const pScale = Math.min(Math.min(pageW, pageH) / imgW, (Math.max(pageW, pageH) / 2) / imgH);
                        const lScale = Math.min((Math.max(pageW, pageH) / 2) / imgW, Math.min(pageW, pageH) / imgH);
                        orientation = (lScale > pScale) ? 'l' : 'p';
                    }
                } else {
                    orientation = orientOpt;
                }

                // Set final dimensions passed to addPage
                let finalPageW, finalPageH;
                if (orientation === 'p') {
                    finalPageW = Math.min(pageW, pageH); finalPageH = Math.max(pageW, pageH);
                } else {
                    finalPageW = Math.max(pageW, pageH); finalPageH = Math.min(pageW, pageH);
                }

                currentDoc.addPage([finalPageW, finalPageH], orientation);

                // DRAWING
                const drawAreaW = finalPageW - (marginVal * 2);
                const drawAreaH = finalPageH - (marginVal * 2);

                if (imgMode === 'standard') {
                    let finalW = drawAreaW; let finalH = finalW / ratio;
                    if (finalH > drawAreaH) { finalH = drawAreaH; finalW = finalH * ratio; }
                    const x = marginVal + (drawAreaW - finalW) / 2;
                    const y = marginVal + (drawAreaH - finalH) / 2;
                    currentDoc.addImage(imgData, 'JPEG', x, y, finalW, finalH);

                    if (separateFiles) {
                        zip.file(`documento_${i + 1}.pdf`, currentDoc.output('blob'));
                    }

                } else if (imgMode === 'duplicate') {
                    // Logic: Split page in 2
                    // If Landscape Page -> Vertical Split (Left/Right)
                    // If Portrait Page -> Horizontal Split (Top/Bottom)

                    const isLandPage = finalPageW > finalPageH;
                    let boxW, boxH, b1X, b1Y, b2X, b2Y;
                    let cutX1, cutY1, cutX2, cutY2;

                    if (isLandPage) {
                        boxW = finalPageW / 2; boxH = finalPageH;
                        b1X = 0; b1Y = 0;
                        b2X = boxW; b2Y = 0;
                        // Cut Line
                        cutX1 = boxW; cutY1 = 10; cutX2 = boxW; cutY2 = finalPageH - 10;
                    } else {
                        boxW = finalPageW; boxH = finalPageH / 2;
                        b1X = 0; b1Y = 0;
                        b2X = 0; b2Y = boxH;
                        // Cut Line
                        cutX1 = 10; cutY1 = boxH; cutX2 = finalPageW - 10; cutY2 = boxH;
                    }

                    // Helper to draw in box honoring margin
                    const drawInBox = (bx, by, bw, bh) => {
                        const innerW = bw - (marginVal * 2);
                        const innerH = bh - (marginVal * 2);
                        let dW = innerW; let dH = dW / ratio;
                        if (dH > innerH) { dH = innerH; dW = dH * ratio; }
                        const imgX = bx + marginVal + (innerW - dW) / 2;
                        const imgY = by + marginVal + (innerH - dH) / 2;
                        currentDoc.addImage(imgData, 'JPEG', imgX, imgY, dW, dH);
                    };

                    drawInBox(b1X, b1Y, boxW, boxH);
                    drawInBox(b2X, b2Y, boxW, boxH);

                    // Draw Cut Line
                    currentDoc.setLineDashPattern([3, 3], 0); currentDoc.setDrawColor(150);
                    currentDoc.line(cutX1, cutY1, cutX2, cutY2);
                    currentDoc.setFontSize(10); currentDoc.setTextColor(150);
                }
            }

            if (separateFiles && imgMode === 'standard') {
                const content = await zip.generateAsync({ type: "blob" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = "documentos_pdf_separados.zip";
                a.click();
            } else {
                doc.save('documento_convertido.pdf');
            }

            hideLoader();
        }

        // ==========================================
        // 2. RESUMIR PDF (N-UP)
        // ==========================================
        let nupFile = null;
        document.getElementById('file-input-nup').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            nupFile = file;
            document.getElementById('nup-upload-area').classList.add('hidden');
            document.getElementById('nup-options').classList.remove('hidden');
        });
        function resetNUp() { nupFile = null; document.getElementById('file-input-nup').value = ''; document.getElementById('nup-options').classList.add('hidden'); document.getElementById('nup-upload-area').classList.remove('hidden'); }
        async function generateNUpPDF() {
            if (!nupFile) return; showLoader("Resumiendo PDF...");
            try {
                const arrayBuffer = await nupFile.arrayBuffer();
                const { PDFDocument, PageSizes } = PDFLib;
                const srcDoc = await PDFDocument.load(arrayBuffer);
                const newDoc = await PDFDocument.create();
                const pagesPerSheet = parseInt(document.getElementById('nup-count').value);
                let cols, rows;
                if (pagesPerSheet === 2) { cols = 1; rows = 2; } else if (pagesPerSheet === 4) { cols = 2; rows = 2; } else if (pagesPerSheet === 6) { cols = 2; rows = 3; } else { cols = 3; rows = 3; }
                const PageWidth = PageSizes.A4[0]; const PageHeight = PageSizes.A4[1];
                const margin = 20; const gap = 10;
                const cellWidth = (PageWidth - (2 * margin) - (gap * (cols - 1))) / cols;
                const cellHeight = (PageHeight - (2 * margin) - (gap * (rows - 1))) / rows;
                const sourcePages = srcDoc.getPages(); const totalSourcePages = sourcePages.length;
                const copiedPages = await newDoc.embedPages(sourcePages);
                let currentPage; const itemsPerPage = cols * rows;
                for (let i = 0; i < totalSourcePages; i++) {
                    const positionIndex = i % itemsPerPage;
                    if (positionIndex === 0) { currentPage = newDoc.addPage(PageSizes.A4); }
                    const col = positionIndex % cols; const row = Math.floor(positionIndex / cols);
                    const embeddedPage = copiedPages[i]; const { width: srcWidth, height: srcHeight } = embeddedPage;
                    const scaleX = cellWidth / srcWidth; const scaleY = cellHeight / srcHeight; const scale = Math.min(scaleX, scaleY);
                    const finalWidth = srcWidth * scale; const finalHeight = srcHeight * scale;
                    const x = margin + (col * (cellWidth + gap)) + ((cellWidth - finalWidth) / 2);
                    const cellTopY = PageHeight - margin - (row * (cellHeight + gap));
                    const y = (cellTopY - cellHeight) + ((cellHeight - finalHeight) / 2);
                    currentPage.drawPage(embeddedPage, { x: x, y: y, width: finalWidth, height: finalHeight, });
                }
                const pdfBytes = await newDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `resumido_${pagesPerSheet}en1.pdf`; link.click();
            } catch (err) { console.error(err); alert("Hubo un error al procesar el PDF: " + err.message); } finally { hideLoader(); }
        }

        // ==========================================
        // 3. DIVIDIR & ROTAR
        // ==========================================
        let splitPdfDoc = null; let splitPages = [];

        document.getElementById('file-input-split').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return; showLoader("Leyendo PDF...");

            try {
                const ab = await file.arrayBuffer();
                const abCopy = ab.slice(0);

                splitPdfDoc = await PDFLib.PDFDocument.load(ab);

                splitPages = [];
                const loadingTask = pdfjsLib.getDocument({ data: abCopy });
                const pdf = await loadingTask.promise;

                document.getElementById('split-page-count').innerText = pdf.numPages;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const vp = page.getViewport({ scale: 0.3 });
                    const c = document.createElement('canvas'); c.width = vp.width; c.height = vp.height;
                    const ctx = c.getContext('2d'); await page.render({ canvasContext: ctx, viewport: vp }).promise;
                    const imgUrl = c.toDataURL('image/jpeg', 0.8);

                    // AÑADIMOS UN ID ÚNICO
                    splitPages.push({ id: `page-${i}-${Date.now()}`, index: i - 1, rotation: 0, imgUrl: imgUrl, originalNum: i });
                }

                document.getElementById('split-upload-area').classList.add('hidden');
                document.getElementById('split-workspace').classList.remove('hidden');
                updateSplitGrid();

            } catch (err) { console.error(err); alert("Error al cargar el PDF.\n" + err.message); } finally { hideLoader(); e.target.value = ''; }
        });

        function updateSplitGrid() {
            const c = document.getElementById('pages-container'); c.innerHTML = '';

            splitPages.forEach((p, displayIdx) => {
                const div = document.createElement('div');
                div.className = "bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-600 relative group cursor-grab active:cursor-grabbing";
                div.setAttribute('data-id', p.id); // IMPORTANTE PARA SORTABLE

                const wrap = document.createElement('div');
                wrap.className = "relative rounded-lg overflow-hidden flex items-center justify-center bg-slate-100 dark:bg-slate-800 aspect-[1/1.4] pointer-events-none";
                const img = document.createElement('img');
                img.src = p.imgUrl;
                img.className = "max-w-full max-h-full object-contain";
                img.style.transform = `rotate(${p.rotation}deg)`;
                img.style.transition = "transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
                wrap.appendChild(img);

                const over = document.createElement('div');
                over.className = "absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center gap-2 transition-opacity backdrop-blur-[1px]";
                over.innerHTML = `
                    <div class="text-white text-xs font-bold mb-1"><i data-lucide="move" class="inline w-3 h-3"></i> Mover</div>
                    <div class="flex gap-2 pointer-events-auto">
                        <button onclick="rotatePage(${displayIdx})" class="w-8 h-8 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow transition-transform hover:scale-110"><i data-lucide="rotate-cw" class="w-4 h-4"></i></button>
                        <button onclick="delPage(${displayIdx})" class="w-8 h-8 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow transition-transform hover:scale-110"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                wrap.appendChild(over);
                div.appendChild(wrap);
                div.innerHTML += `<div class="text-center mt-2 text-xs font-bold text-slate-500 dark:text-slate-300">Pág. orig: ${p.originalNum}</div>`;
                c.appendChild(div);
            });
            lucide.createIcons();

            enableDragSort('pages-container', splitPages, null);
        }
        function rotatePage(idx) { splitPages[idx].rotation = (splitPages[idx].rotation + 90) % 360; updateSplitGrid(); }
        function delPage(i) { splitPages.splice(i, 1); updateSplitGrid(); }
        function resetSplit() { splitPdfDoc = null; splitPages = []; document.getElementById('split-workspace').classList.add('hidden'); document.getElementById('split-upload-area').classList.remove('hidden'); }
        async function downloadSplitPDF() {
            if (!splitPages.length) return alert("¡No has dejado ninguna página!"); showLoader("Guardando PDF...");
            try {
                const newPdf = await PDFLib.PDFDocument.create();

                // IMPORTANTE: Mapear indices originales correctamente
                const indices = splitPages.map(p => p.index);
                const copied = await newPdf.copyPages(splitPdfDoc, indices);

                copied.forEach((page, i) => {
                    const addedRot = splitPages[i].rotation;
                    const currentRot = page.getRotation().angle;
                    page.setRotation(PDFLib.degrees((currentRot + addedRot) % 360));
                    newPdf.addPage(page);
                });
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `editado_${Date.now()}.pdf`; link.click();
            } catch (e) { console.error(e); alert("Error al guardar."); } finally { hideLoader(); }
        }

        // ==========================================
        // 4. UNIR (MERGE) - DRAG & DROP ENABLED
        // ==========================================
        let mergePagesData = [];
        let mergeSourceFiles = {};

        document.getElementById('file-input-merge').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            showLoader("Procesando archivos...");

            try {
                for (const file of files) {
                    const fileId = Math.random().toString(36).substring(7);
                    const arrayBuffer = await file.arrayBuffer();
                    mergeSourceFiles[fileId] = arrayBuffer.slice(0);

                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer.slice(0) });
                    const pdf = await loadingTask.promise;

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const vp = page.getViewport({ scale: 0.3 });
                        const canvas = document.createElement('canvas'); canvas.width = vp.width; canvas.height = vp.height;
                        const ctx = canvas.getContext('2d'); await page.render({ canvasContext: ctx, viewport: vp }).promise;

                        mergePagesData.push({
                            id: Math.random().toString(36), // ID UNICO NECESARIO
                            fileId: fileId,
                            fileName: file.name,
                            pageIndex: i - 1,
                            rotation: 0,
                            thumbUrl: canvas.toDataURL('image/jpeg', 0.8)
                        });
                    }
                }
                document.getElementById('merge-workspace').classList.remove('hidden');
                renderMergeGrid();
            } catch (err) { console.error(err); alert("Error al cargar archivos: " + err.message); } finally { hideLoader(); e.target.value = ''; }
        });

        function renderMergeGrid() {
            const grid = document.getElementById('merge-grid');
            grid.innerHTML = '';
            document.getElementById('merge-page-count').innerText = mergePagesData.length;

            if (mergePagesData.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-400 dark:text-slate-500 py-8">No hay páginas. Añade PDFs.</div>';
                return;
            }

            mergePagesData.forEach((page, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-600 relative group cursor-grab active:cursor-grabbing";
                div.setAttribute('data-id', page.id); // ID PARA SORTABLE

                const wrap = document.createElement('div');
                wrap.className = "relative rounded-lg overflow-hidden flex items-center justify-center bg-slate-100 dark:bg-slate-800 aspect-[1/1.4] pointer-events-none";
                const img = document.createElement('img'); img.src = page.thumbUrl; img.className = "max-w-full max-h-full object-contain";
                img.style.transform = `rotate(${page.rotation}deg)`; img.style.transition = "transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
                wrap.appendChild(img);

                const over = document.createElement('div');
                over.className = "absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center gap-2 transition-opacity backdrop-blur-[1px]";
                over.innerHTML = `
                    <div class="text-white text-xs font-bold mb-1"><i data-lucide="move" class="inline w-3 h-3"></i> Mover</div>
                    <div class="flex gap-2 pointer-events-auto">
                        <button onclick="rotateMergePage(${idx})" class="w-8 h-8 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow transition-transform hover:scale-110"><i data-lucide="rotate-cw" class="w-4 h-4"></i></button>
                        <button onclick="removeMergePage(${idx})" class="w-8 h-8 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow transition-transform hover:scale-110"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                wrap.appendChild(over); div.appendChild(wrap);

                div.innerHTML += `<div class="mt-2 text-center"><p class="text-[10px] text-slate-400 dark:text-slate-400 truncate w-full">${page.fileName}</p><p class="text-xs font-bold text-slate-600 dark:text-slate-300">Pág ${page.pageIndex + 1}</p></div>`;
                grid.appendChild(div);
            });
            lucide.createIcons();

            enableDragSort('merge-grid', mergePagesData, null);
        }

        function rotateMergePage(idx) { mergePagesData[idx].rotation = (mergePagesData[idx].rotation + 90) % 360; renderMergeGrid(); }
        function removeMergePage(idx) { mergePagesData.splice(idx, 1); renderMergeGrid(); }
        function resetMerge() { mergePagesData = []; mergeSourceFiles = {}; document.getElementById('merge-grid').innerHTML = ''; document.getElementById('merge-workspace').classList.add('hidden'); }

        async function mergePDFs() {
            if (mergePagesData.length === 0) return alert("No hay páginas para unir.");
            showLoader("Uniendo documentos...");

            try {
                const newDoc = await PDFLib.PDFDocument.create();
                const loadedDocsCache = {};

                for (const pageData of mergePagesData) {
                    const { fileId, pageIndex, rotation } = pageData;
                    if (!loadedDocsCache[fileId]) { loadedDocsCache[fileId] = await PDFLib.PDFDocument.load(mergeSourceFiles[fileId]); }
                    const srcDoc = loadedDocsCache[fileId];
                    const [copiedPage] = await newDoc.copyPages(srcDoc, [pageIndex]);
                    const currentRotation = copiedPage.getRotation().angle;
                    copiedPage.setRotation(PDFLib.degrees((currentRotation + rotation) % 360));
                    newDoc.addPage(copiedPage);
                }
                const pdfBytes = await newDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `unido_completo_${Date.now()}.pdf`; link.click();
            } catch (err) { console.error(err); alert("Error al unir: " + err.message); } finally { hideLoader(); }
        }

        // ==========================================
        // 5. PDF A IMÁGENES
        // ==========================================
        let p2iImages = [];
        document.getElementById('file-input-p2i').addEventListener('change', async (e) => {
            const f = e.target.files[0]; if (!f) return; showLoader("Extrayendo imágenes...");
            try {
                const ab = await f.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
                p2iImages = [];
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const vp = page.getViewport({ scale: 2.0 });
                    const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
                    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                    const blob = await new Promise(resolve => cvs.toBlob(resolve, 'image/jpeg', 0.9));
                    p2iImages.push({ id: Math.random().toString(36), blob: blob, name: `pagina_${i}.jpg`, rotation: 0, url: URL.createObjectURL(blob) });
                }
                document.getElementById('p2i-upload-area').classList.add('hidden');
                document.getElementById('p2i-workspace').classList.remove('hidden');
                renderP2IGrid();
            } catch (e) { console.error(e); alert("Error al leer PDF"); } finally { hideLoader(); e.target.value = ''; }
        });
        function renderP2IGrid() {
            const grid = document.getElementById('p2i-grid'); grid.innerHTML = '';
            if (p2iImages.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">No quedan imágenes</div>'; return; }
            p2iImages.forEach((img, idx) => {
                grid.innerHTML += `
                <div class="bg-white dark:bg-slate-700 p-2 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm relative group cursor-grab active:cursor-grabbing" data-id="${img.id}">
                    <div class="relative overflow-hidden bg-slate-100 dark:bg-slate-800 rounded border dark:border-slate-600 mb-2 aspect-[1/1.4] flex items-center justify-center pointer-events-none">
                        <img src="${img.url}" style="transform: rotate(${img.rotation}deg); transition: transform 0.3s;" class="max-w-full max-h-full object-contain">
                    </div>
                    <div class="flex justify-between items-center px-1">
                        <span class="text-xs font-bold text-slate-500 dark:text-slate-300">Pág ${idx + 1}</span>
                        <div class="flex gap-1 pointer-events-auto">
                            <button onclick="rotateP2I(${idx}, 90)" class="p-1.5 text-slate-600 dark:text-slate-400 hover:bg-blue-50 dark:hover:bg-slate-600 hover:text-blue-600 rounded"><i data-lucide="rotate-cw" class="w-4 h-4"></i></button>
                            <button onclick="deleteP2I(${idx})" class="p-1.5 text-slate-400 hover:bg-red-50 hover:text-red-500 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            lucide.createIcons();
            enableDragSort('p2i-grid', p2iImages, null);
        }
        function rotateP2I(idx, deg) { p2iImages[idx].rotation = (p2iImages[idx].rotation + deg) % 360; renderP2IGrid(); }
        function deleteP2I(idx) { p2iImages.splice(idx, 1); renderP2IGrid(); }
        async function downloadAllImagesZip() {
            if (!p2iImages.length) return; showLoader("Comprimiendo...");
            const zip = new JSZip();
            for (const img of p2iImages) {
                if (img.rotation === 0) { zip.file(img.name, img.blob); } else { const rotatedBlob = await rotateImageBlob(img.url, img.rotation); zip.file(img.name, rotatedBlob); }
            }
            const content = await zip.generateAsync({ type: "blob" }); const a = document.createElement("a"); a.href = URL.createObjectURL(content); a.download = "imagenes_extraidas.zip"; a.click(); hideLoader();
        }
        function rotateImageBlob(url, degrees) {
            return new Promise((resolve) => {
                const image = new Image();
                image.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const rads = degrees * Math.PI / 180; const sin = Math.abs(Math.sin(rads)); const cos = Math.abs(Math.cos(rads));
                    canvas.width = image.width * cos + image.height * sin; canvas.height = image.width * sin + image.height * cos;
                    ctx.translate(canvas.width / 2, canvas.height / 2); ctx.rotate(rads); ctx.drawImage(image, -image.width / 2, -image.height / 2);
                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                };
                image.src = url;
            });
        }
        function resetP2I() { p2iImages = []; document.getElementById('p2i-workspace').classList.add('hidden'); document.getElementById('p2i-upload-area').classList.remove('hidden'); }

        // ==========================================
        // 6. PÓSTER & 7. COLLAGE (MODIFICADO PARA CALIDAD Y CONTADOR)
        // ==========================================
        let posterImages = []; // Ahora es un Array para soportar multiples
        let currentPosterIndex = 0;

        document.getElementById('file-input-poster').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            showLoader("Cargando archivos...");

            posterImages = []; // Resetear para nueva carga
            currentPosterIndex = 0;

            try {
                for (const f of files) {
                    let u = null, ext = f.name.split('.').pop().toLowerCase();
                    if (ext === 'pdf') {
                        const ab = await f.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
                        const p = await pdf.getPage(1);
                        const vp = p.getViewport({ scale: 5 }); // HIGH QUALITY (360 DPI approx)
                        const c = document.createElement('canvas'); c.width = vp.width; c.height = vp.height;
                        await p.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
                        u = c.toDataURL('image/jpeg', 0.95);
                    }
                    else if (ext === 'heic' || ext === 'heif') { u = await blobToDataURL(await heic2any({ blob: f, toType: "image/jpeg" })); }
                    else { u = await blobToDataURL(f); }

                    const imgObj = await loadImage(u);
                    posterImages.push(imgObj);
                }

                document.getElementById('poster-upload-area').classList.add('hidden');
                document.getElementById('poster-workspace').classList.remove('hidden');
                updatePosterNav();
                renderPosterPreview();
            } catch (e) { console.error(e); alert("Error al cargar archivo(s)."); } finally { hideLoader(); }
        });

        function updatePosterNav() {
            const count = posterImages.length;
            document.getElementById('poster-counter').innerText = `${currentPosterIndex + 1}/${count}`;
            document.getElementById('poster-nav').style.visibility = count > 1 ? 'visible' : 'hidden';
        }

        function nextPoster() { if (currentPosterIndex < posterImages.length - 1) { currentPosterIndex++; updatePosterNav(); renderPosterPreview(); } }
        function prevPoster() { if (currentPosterIndex > 0) { currentPosterIndex--; updatePosterNav(); renderPosterPreview(); } }

        function renderPosterPreview() {
            const posterImage = posterImages[currentPosterIndex]; if (!posterImage) return;
            const c = parseInt(document.getElementById('poster-cols').value) || 1;
            const r = parseInt(document.getElementById('poster-rows').value) || 1;
            const totalPages = c * r * posterImages.length; const singleFilePages = c * r;
            const text = posterImages.length > 1 ? `${singleFilePages} por archivo (Total: ${totalPages})` : `${singleFilePages}`;
            document.getElementById('poster-total-pages').innerText = text;

            const cvs = document.getElementById('poster-preview-canvas'); const ctx = cvs.getContext('2d');
            const s = Math.min(800 / posterImage.width, 1); cvs.width = posterImage.width * s; cvs.height = posterImage.height * s;
            ctx.drawImage(posterImage, 0, 0, cvs.width, cvs.height);
            ctx.strokeStyle = '#ec4899'; ctx.lineWidth = 2; ctx.setLineDash([10, 5]);
            const cw = cvs.width / c; const ch = cvs.height / r;
            for (let i = 1; i < c; i++) { ctx.beginPath(); ctx.moveTo(cw * i, 0); ctx.lineTo(cw * i, cvs.height); ctx.stroke(); }
            for (let i = 1; i < r; i++) { ctx.beginPath(); ctx.moveTo(0, ch * i); ctx.lineTo(cvs.width, ch * i); ctx.stroke(); }
        }

        function resetPoster() { posterImages = []; currentPosterIndex = 0; document.getElementById('file-input-poster').value = ''; document.getElementById('poster-workspace').classList.add('hidden'); document.getElementById('poster-upload-area').classList.remove('hidden'); }

        async function generatePosterPDF() {
            if (!posterImages.length) return; showLoader("Generando Alta Calidad...");
            await new Promise(r => setTimeout(r, 100));

            const cols = parseInt(document.getElementById('poster-cols').value);
            const rows = parseInt(document.getElementById('poster-rows').value);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            doc.deletePage(1);

            for (const posterImage of posterImages) {
                const sw = posterImage.width / cols; const sh = posterImage.height / rows;
                const tc = document.createElement('canvas'); tc.width = sw; tc.height = sh; const tctx = tc.getContext('2d');
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        tctx.clearRect(0, 0, sw, sh);
                        tctx.drawImage(posterImage, c * sw, r * sh, sw, sh, 0, 0, sw, sh);
                        doc.addPage('a4', 'p');
                        const tileData = tc.toDataURL('image/png');
                        doc.addImage(tileData, 'PNG', 0, 0, 210, 297);
                    }
                }
            }
            doc.save('poster_hq.pdf'); hideLoader();
        }

        // COLLAGE
        let collageImages = []; let collageTemplate = 'grid';
        document.getElementById('file-input-collage').addEventListener('change', async (e) => { const f = Array.from(e.target.files); if (!f.length) return; showLoader("Cargando..."); for (const file of f) { let u = null, ext = file.name.split('.').pop().toLowerCase(); if (['heic', 'heif'].includes(ext)) u = await blobToDataURL(await heic2any({ blob: file, toType: "image/jpeg" })); else u = await blobToDataURL(file); collageImages.push(await loadImage(u)); } hideLoader(); document.getElementById('collage-upload-area').classList.add('hidden'); document.getElementById('collage-workspace').classList.remove('hidden'); renderCollage(); });
        function setCollageTemplate(t) { collageTemplate = t; document.querySelectorAll('.template-option').forEach(e => e.classList.remove('selected')); document.getElementById('tmpl-' + t).classList.add('selected'); renderCollage(); }
        function setBg(c) { document.getElementById('collage-bg').value = c; updateCollageSettings(); }
        function updateCollageSettings() { document.getElementById('gap-val').innerText = document.getElementById('collage-gap').value + 'px'; renderCollage(); }

        function renderCollage() {
            if (!collageImages.length) return; const cvs = document.getElementById('collage-canvas'), ctx = cvs.getContext('2d'), gap = parseInt(document.getElementById('collage-gap').value), W = 1200, H = 1200;
            cvs.width = W; cvs.height = H; ctx.fillStyle = document.getElementById('collage-bg').value; ctx.fillRect(0, 0, W, H);
            const count = collageImages.length;

            if (collageTemplate === 'grid') { const cols = Math.ceil(Math.sqrt(count)), rows = Math.ceil(count / cols), cw = (W - (gap * (cols + 1))) / cols, ch = (H - (gap * (rows + 1))) / rows; collageImages.forEach((img, i) => { const c = i % cols, r = Math.floor(i / cols); drawContain(ctx, img, gap + c * (cw + gap), gap + r * (ch + gap), cw, ch); }); }
            else if (collageTemplate === 'mosaic') { if (count === 0) return; const bw = (W - gap * 3) / 2, bh = H - gap * 2; drawContain(ctx, collageImages[0], gap, gap, bw, bh); const rem = collageImages.slice(1); if (rem.length) { const sh = (H - (gap * (rem.length + 1))) / rem.length; rem.forEach((img, i) => { drawContain(ctx, img, gap * 2 + bw, gap + i * (sh + gap), bw, sh); }); } }
            else if (collageTemplate === 'strip') { const rh = (H - (gap * (count + 1))) / count, rw = W - gap * 2; collageImages.forEach((img, i) => { drawContain(ctx, img, gap, gap + i * (rh + gap), rw, rh); }); }
            else if (collageTemplate === 'pile') { const sz = W * 0.4; collageImages.forEach(img => { ctx.save(); ctx.translate((W / 2) + (Math.random() - 0.5) * (W * 0.4), (H / 2) + (Math.random() - 0.5) * (H * 0.4)); ctx.rotate((Math.random() - 0.5) * 0.5); ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 20; ctx.fillStyle = "white"; ctx.fillRect(-sz / 2 - 20, -sz / 2 - 20, sz + 40, sz + 40 + 40); ctx.shadowColor = "transparent"; drawContain(ctx, img, -sz / 2, -sz / 2, sz, sz); ctx.restore(); }); }

            else if (collageTemplate === '2v') { const w = (W - gap * 3) / 2, h = H - gap * 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w, h); if (collageImages[1]) drawContain(ctx, collageImages[1], gap * 2 + w, gap, w, h); }
            else if (collageTemplate === '2h') { const w = W - gap * 2, h = (H - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w, h); if (collageImages[1]) drawContain(ctx, collageImages[1], gap, gap * 2 + h, w, h); }
            else if (collageTemplate === '3v') { const w = (W - gap * 4) / 3, h = H - gap * 2; collageImages.forEach((img, i) => { if (i < 3) drawContain(ctx, img, gap + i * (w + gap), gap, w, h); }); }
            else if (collageTemplate === '3h') { const w = W - gap * 2, h = (H - gap * 4) / 3; collageImages.forEach((img, i) => { if (i < 3) drawContain(ctx, img, gap + i * (h + gap), w, h); }); }
            else if (collageTemplate === '1u2d') { const h1 = (H - gap * 3) / 2; const w2 = (W - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, W - gap * 2, h1); if (collageImages[1]) drawContain(ctx, collageImages[1], gap, gap * 2 + h1, w2, h1); if (collageImages[2]) drawContain(ctx, collageImages[2], gap * 2 + w2, gap * 2 + h1, w2, h1); }
            else if (collageTemplate === '2u1d') { const h1 = (H - gap * 3) / 2; const w2 = (W - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w2, h1); if (collageImages[1]) drawContain(ctx, collageImages[1], gap * 2 + w2, gap, w2, h1); if (collageImages[2]) drawContain(ctx, collageImages[2], gap, gap * 2 + h1, W - gap * 2, h1); }
            else if (collageTemplate === '1l2r') { const w1 = (W - gap * 3) / 2; const h2 = (H - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w1, H - gap * 2); if (collageImages[1]) drawContain(ctx, collageImages[1], gap * 2 + w1, gap, w1, h2); if (collageImages[2]) drawContain(ctx, collageImages[2], gap * 2 + w1, gap * 2 + h2, w1, h2); }
            else if (collageTemplate === '2l1r') { const w1 = (W - gap * 3) / 2; const h2 = (H - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w1, h2); if (collageImages[1]) drawContain(ctx, collageImages[1], gap, gap * 2 + h2, w1, h2); if (collageImages[2]) drawContain(ctx, collageImages[2], gap * 2 + w1, gap, w1, H - gap * 2); }
            else if (collageTemplate === '2x2') { const w = (W - gap * 3) / 2, h = (H - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w, h); if (collageImages[1]) drawContain(ctx, collageImages[1], gap * 2 + w, gap, w, h); if (collageImages[2]) drawContain(ctx, collageImages[2], gap, gap * 2 + h, w, h); if (collageImages[3]) drawContain(ctx, collageImages[3], gap * 2 + w, gap * 2 + h, w, h); }
            else if (collageTemplate === '1u3d') { const h1 = (H - gap * 3) * 0.6; const h2 = (H - gap * 3) * 0.4; const w2 = (W - gap * 4) / 3; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, W - gap * 2, h1); for (let i = 0; i < 3; i++) if (collageImages[i + 1]) drawContain(ctx, collageImages[i + 1], gap + i * (w2 + gap), gap * 2 + h1, w2, h2); }
            else if (collageTemplate === '3u1d') { const h1 = (H - gap * 3) * 0.4; const h2 = (H - gap * 3) * 0.6; const w1 = (W - gap * 4) / 3; for (let i = 0; i < 3; i++) if (collageImages[i]) drawContain(ctx, collageImages[i], gap + i * (w1 + gap), gap, w1, h1); if (collageImages[3]) drawContain(ctx, collageImages[3], gap, gap * 2 + h1, W - gap * 2, h2); }
            else if (collageTemplate === '1l3r') { const w1 = (W - gap * 3) * 0.6; const w2 = (W - gap * 3) * 0.4; const h2 = (H - gap * 4) / 3; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w1, H - gap * 2); for (let i = 0; i < 3; i++) if (collageImages[i + 1]) drawContain(ctx, collageImages[i + 1], gap * 2 + w1, gap + i * (h2 + gap), w2, h2); }
            else if (collageTemplate === '3l1r') { const w1 = (W - gap * 3) * 0.4; const w2 = (W - gap * 3) * 0.6; const h1 = (H - gap * 4) / 3; for (let i = 0; i < 3; i++) if (collageImages[i]) drawContain(ctx, collageImages[i], gap, gap + i * (h1 + gap), w1, h1); if (collageImages[3]) drawContain(ctx, collageImages[3], gap * 2 + w1, gap, w2, H - gap * 2); }
            else if (collageTemplate === '2u3d') { const h = (H - gap * 3) / 2; const w1 = (W - gap * 3) / 2; const w2 = (W - gap * 4) / 3; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w1, h); if (collageImages[1]) drawContain(ctx, collageImages[1], gap * 2 + w1, gap, w1, h); for (let i = 0; i < 3; i++) if (collageImages[i + 2]) drawContain(ctx, collageImages[i + 2], gap + i * (w2 + gap), gap * 2 + h, w2, h); }
            else if (collageTemplate === '3u2d') { const h = (H - gap * 3) / 2; const w1 = (W - gap * 4) / 3; const w2 = (W - gap * 3) / 2; for (let i = 0; i < 3; i++) if (collageImages[i]) drawContain(ctx, collageImages[i], gap + i * (w1 + gap), gap, w1, h); if (collageImages[3]) drawContain(ctx, collageImages[3], gap, gap * 2 + h, w2, h); if (collageImages[4]) drawContain(ctx, collageImages[4], gap * 2 + w2, gap * 2 + h, w2, h); }
            else if (collageTemplate === '1l4r') { const w1 = (W - gap * 3) * 0.5; const w2 = (W - gap * 3) * 0.5; const h2 = (H - gap * 3) / 2; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, w1, H - gap * 2); const wSub = (w2 - gap) / 2; if (collageImages[1]) drawContain(ctx, collageImages[1], gap * 2 + w1, gap, wSub, h2); if (collageImages[2]) drawContain(ctx, collageImages[2], gap * 2 + w1 + wSub + gap, gap, wSub, h2); if (collageImages[3]) drawContain(ctx, collageImages[3], gap * 2 + w1, gap * 2 + h2, wSub, h2); if (collageImages[4]) drawContain(ctx, collageImages[4], gap * 2 + w1 + wSub + gap, gap * 2 + h2, wSub, h2); }
            else if (collageTemplate === '2x3') { const w = (W - gap * 3) / 2, h = (H - gap * 4) / 3; collageImages.forEach((img, i) => { if (i < 6) { const c = i % 2, r = Math.floor(i / 2); drawContain(ctx, img, gap + c * (w + gap), gap + r * (h + gap), w, h); } }); }
            else if (collageTemplate === '3x2') { const w = (W - gap * 4) / 3, h = (H - gap * 3) / 2; collageImages.forEach((img, i) => { if (i < 6) { const c = i % 3, r = Math.floor(i / 3); drawContain(ctx, img, gap + c * (w + gap), gap + r * (h + gap), w, h); } }); }
            else if (collageTemplate === '1u5d') { const h1 = (H - gap * 3) * 0.5; const h2 = (H - gap * 3) * 0.5; const w2 = (W - gap * 6) / 5; if (collageImages[0]) drawContain(ctx, collageImages[0], gap, gap, W - gap * 2, h1); for (let i = 0; i < 5; i++) if (collageImages[i + 1]) drawContain(ctx, collageImages[i + 1], gap + i * (w2 + gap), gap * 2 + h1, w2, h2); }
            else if (collageTemplate === '4x2') { const w = (W - gap * 5) / 4, h = (H - gap * 3) / 2; collageImages.forEach((img, i) => { if (i < 8) { const c = i % 4, r = Math.floor(i / 4); drawContain(ctx, img, gap + c * (w + gap), gap + r * (h + gap), w, h); } }); }
            else if (collageTemplate === '3x3') { const w = (W - gap * 4) / 3, h = (H - gap * 4) / 3; collageImages.forEach((img, i) => { if (i < 9) { const c = i % 3, r = Math.floor(i / 3); drawContain(ctx, img, gap + c * (w + gap), gap + r * (h + gap), w, h); } }); }
        }
        function drawContain(ctx, img, x, y, w, h) { const r = img.width / img.height, tr = w / h; let dx, dy, dw, dh; if (r > tr) { dw = w; dh = w / r; dx = x; dy = y + (h - dh) / 2; } else { dh = h; dw = h * r; dy = y; dx = x + (w - dw) / 2; } ctx.drawImage(img, 0, 0, img.width, img.height, dx, dy, dw, dh); }
        function resetCollage() { collageImages = []; document.getElementById('collage-upload-area').classList.remove('hidden'); document.getElementById('collage-workspace').classList.add('hidden'); document.getElementById('file-input-collage').value = ''; }
        function downloadCollage() { const l = document.createElement('a'); l.download = `collage_${Date.now()}.png`; l.href = document.getElementById('collage-canvas').toDataURL(); l.click(); }
    </script>
    <script>
        // ==========================================
        // 8. MARCA DE AGUA
        // ==========================================
        let wmFile = null;
        document.getElementById('file-input-watermark').addEventListener('change', (e) => {
            const f = e.target.files[0]; if (!f) return;
            wmFile = f;
            document.getElementById('watermark-upload-area').classList.add('hidden');
            document.getElementById('watermark-workspace').classList.remove('hidden');
        });
        function resetWatermark() { wmFile = null; document.getElementById('file-input-watermark').value = ''; document.getElementById('watermark-workspace').classList.add('hidden'); document.getElementById('watermark-upload-area').classList.remove('hidden'); }

        async function generateWatermark() {
            if (!wmFile) return; showLoader("Aplicando Marca de Agua...");
            try {
                const ab = await wmFile.arrayBuffer();
                const doc = await PDFLib.PDFDocument.load(ab);
                const text = document.getElementById('wm-text').value;
                const colorHex = document.getElementById('wm-color').value;
                const opacity = parseFloat(document.getElementById('wm-opacity').value);
                const rotation = parseInt(document.getElementById('wm-rotation').value);
                const size = parseInt(document.getElementById('wm-size').value);

                // Convert hex to rgb
                const r = parseInt(colorHex.substr(1, 2), 16) / 255;
                const g = parseInt(colorHex.substr(3, 2), 16) / 255;
                const b = parseInt(colorHex.substr(5, 2), 16) / 255;

                const pages = doc.getPages();
                pages.forEach(page => {
                    const { width, height } = page.getSize();
                    page.drawText(text, {
                        x: width / 2 - (text.length * size / 4), // Simple centering approx
                        y: height / 2,
                        size: size,
                        color: PDFLib.rgb(r, g, b),
                        opacity: opacity,
                        rotate: PDFLib.degrees(rotation),
                    });
                });

                const pdfBytes = await doc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'watermarked.pdf'; link.click();
            } catch (e) { console.error(e); alert("Error: " + e.message); } finally { hideLoader(); }
        }

        // ==========================================
        // 9. NÚMEROS DE PÁGINA
        // ==========================================
        let pnFile = null;
        document.getElementById('file-input-pagenum').addEventListener('change', (e) => {
            const f = e.target.files[0]; if (!f) return;
            pnFile = f;
            document.getElementById('pagenum-upload-area').classList.add('hidden');
            document.getElementById('pagenum-workspace').classList.remove('hidden');
        });
        function resetPageNum() { pnFile = null; document.getElementById('file-input-pagenum').value = ''; document.getElementById('pagenum-workspace').classList.add('hidden'); document.getElementById('pagenum-upload-area').classList.remove('hidden'); }

        async function generatePageNum() {
            if (!pnFile) return; showLoader("Numerando...");
            try {
                const ab = await pnFile.arrayBuffer();
                const doc = await PDFLib.PDFDocument.load(ab);
                const pos = document.getElementById('pn-position').value;
                const fmt = document.getElementById('pn-format').value;
                const pages = doc.getPages();
                const total = pages.length;

                pages.forEach((page, idx) => {
                    const { width, height } = page.getSize();
                    let text = '';
                    const n = idx + 1;
                    if (fmt === 'n') text = `${n}`;
                    else if (fmt === 'p-n') text = `Página ${n}`;
                    else if (fmt === 'n-of-total') text = `${n} de ${total}`;

                    let x = 0, y = 20; // Default bottom
                    const textWidth = text.length * 12 * 0.6; // Approx width

                    if (pos.includes('bottom')) y = 20;
                    else y = height - 20;

                    if (pos.includes('left')) x = 20;
                    else if (pos.includes('center')) x = (width / 2) - (textWidth / 2);
                    else x = width - textWidth - 20;

                    page.drawText(text, { x, y, size: 12, color: PDFLib.rgb(0, 0, 0) });
                });

                const pdfBytes = await doc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'numerado.pdf'; link.click();
            } catch (e) { console.error(e); alert("Error: " + e.message); } finally { hideLoader(); }
        }



        // ==========================================
        // 11. FIRMAR PDF
        // ==========================================
        let signFile = null; let signPdfBytes = null; let signPageIdx = 0; let signScale = 1; let signCoords = { x: 0, y: 0 };
        let signImgData = null; // DataURL de la firma

        // CANVAS DE DIBUJO
        const sigCanvas = document.getElementById('sig-canvas');
        const sigCtx = sigCanvas.getContext('2d');
        let painting = false;

        function startPosition(e) { painting = true; draw(e); }
        function endPosition() { painting = false; sigCtx.beginPath(); }
        function draw(e) {
            if (!painting) return;
            e.preventDefault();
            const rect = sigCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            sigCtx.lineWidth = 2; sigCtx.lineCap = 'round'; sigCtx.strokeStyle = 'black';
            sigCtx.lineTo(clientX - rect.left, clientY - rect.top);
            sigCtx.stroke();
            sigCtx.beginPath();
            sigCtx.moveTo(clientX - rect.left, clientY - rect.top);
        }

        // Eventos ratón y touch
        sigCanvas.addEventListener('mousedown', startPosition); sigCanvas.addEventListener('mouseup', endPosition); sigCanvas.addEventListener('mousemove', draw);
        sigCanvas.addEventListener('touchstart', startPosition); sigCanvas.addEventListener('touchend', endPosition); sigCanvas.addEventListener('touchmove', draw);

        // --- GESTIÓN DE PESTAÑAS Y MODOS DE FIRMA ---
        let currentSignMode = 'draw'; // draw, type, upload
        let selectedFont = 'Great Vibes';
        let selectedUploadImg = null;

        function setSignTab(mode) {
            currentSignMode = mode;
            // Update Tab UI
            ['draw', 'type', 'upload'].forEach(m => {
                const btn = document.getElementById(`tab-sign-${m}`);
                const content = document.getElementById(`sign-content-${m}`);
                if (m === mode) {
                    btn.classList.replace('text-slate-500', 'text-slate-800');
                    btn.classList.replace('dark:text-slate-400', 'dark:text-slate-200');
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'shadow');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.replace('text-slate-800', 'text-slate-500');
                    btn.classList.replace('dark:text-slate-200', 'dark:text-slate-400');
                    btn.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow');
                    content.classList.add('hidden');
                }
            });
            // Reset actions area if changing modes
            // document.getElementById('sig-actions').classList.add('hidden');
        }

        function setSignColor(color) {
            document.getElementById('sign-color-val').value = color;
            renderTypePreviews();
        }

        function renderTypePreviews() {
            const text = document.getElementById('sign-text-input').value || "Tu Firma";
            const color = document.getElementById('sign-color-val').value;
            const fonts = ['Great Vibes', 'Dancing Script', 'Sacramento', 'Allura'];
            const container = document.getElementById('type-previews');
            container.innerHTML = '';

            fonts.forEach(font => {
                const div = document.createElement('div');
                div.className = `p-2 rounded border cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors ${selectedFont === font ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-slate-200 dark:border-slate-600'}`;
                div.onclick = () => { selectedFont = font; renderTypePreviews(); };

                const span = document.createElement('span');
                span.style.fontFamily = font;
                span.style.color = color;
                span.style.fontSize = "24px";
                span.innerText = text;

                div.appendChild(span);
                container.appendChild(div);
            });
        }

        function handleSignUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedUploadImg = e.target.result;
                    const preview = document.getElementById('sign-upload-preview');
                    preview.innerHTML = `<img src="${selectedUploadImg}" class="max-h-[100px] object-contain">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function clearSig() {
            sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
            signImgData = null;
            document.getElementById('sig-ghost').classList.add('hidden');
            document.getElementById('sig-actions').classList.add('hidden');
        }

        async function saveSig() {
            if (currentSignMode === 'draw') {
                signImgData = sigCanvas.toDataURL('image/png');
            } else if (currentSignMode === 'type') {
                const text = document.getElementById('sign-text-input').value;
                if (!text) return alert("Escribe tu nombre primero");
                const color = document.getElementById('sign-color-val').value;

                // Generar canvas temporal
                const c = document.createElement('canvas');
                const ctx = c.getContext('2d');
                ctx.font = `60px "${selectedFont}"`;
                const textMetrics = ctx.measureText(text);
                c.width = textMetrics.width + 20;
                c.height = 100; // Altura fija suficiente

                // Redibujar con dimensiones correctas
                ctx.font = `60px "${selectedFont}"`;
                ctx.fillStyle = color;
                ctx.textBaseline = 'middle';
                ctx.fillText(text, 10, 50);

                signImgData = c.toDataURL('image/png');
            } else if (currentSignMode === 'upload') {
                if (!selectedUploadImg) return alert("Sube una imagen primero");
                signImgData = selectedUploadImg;
            }

            document.getElementById('sig-actions').classList.remove('hidden');
            // Activar modo colocación
            document.getElementById('sig-ghost').innerHTML = `<img src="${signImgData}" class="w-full h-full object-contain">`;
            document.getElementById('sig-ghost').classList.remove('hidden');
            alert("Firma generada. Ahora haz clic en el PDF (derecha) para colocarla.");
        }

        document.getElementById('file-input-sign').addEventListener('change', async (e) => {
            const f = e.target.files[0]; if (!f) return;
            signFile = f;
            showLoader("Cargando PDF...");
            try {
                signPdfBytes = await f.arrayBuffer();
                document.getElementById('sign-upload-area').classList.add('hidden');
                document.getElementById('sign-workspace').classList.remove('hidden');
                signPageIdx = 0;
                await renderSignPage();
            } catch (e) { console.error(e); } finally { hideLoader(); }
        });

        async function renderSignPage() {
            const pdf = await pdfjsLib.getDocument({ data: signPdfBytes.slice(0) }).promise;
            const page = await pdf.getPage(signPageIdx + 1);
            const viewport = page.getViewport({ scale: 1 });
            const container = document.getElementById('sign-pdf-container');
            // Ajustar escala para que quepa en el contenedor (aprox 500px width o height)
            const availableW = container.clientWidth || 500;
            const scale = availableW / viewport.width;
            signScale = scale;
            const scaledViewport = page.getViewport({ scale: scale });

            const canvas = document.getElementById('sign-pdf-canvas');
            canvas.width = scaledViewport.width; canvas.height = scaledViewport.height;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: scaledViewport }).promise;
            document.getElementById('sign-page-indicator').innerText = `Pág ${signPageIdx + 1} de ${pdf.numPages}`;
        }

        function prevSignPage() { if (signPageIdx > 0) { signPageIdx--; renderSignPage(); } }
        async function nextSignPage() {
            const pdf = await pdfjsLib.getDocument({ data: signPdfBytes.slice(0) }).promise;
            if (signPageIdx < pdf.numPages - 1) { signPageIdx++; renderSignPage(); }
        }
        function resetSign() { clearSig(); signFile = null; signPdfBytes = null; document.getElementById('sign-workspace').classList.add('hidden'); document.getElementById('sign-upload-area').classList.remove('hidden'); document.getElementById('file-input-sign').value = ''; }

        function placeSignatureOnPage(e) {
            if (!signImgData) return alert("Primero dibuja y guarda tu firma.");
            const rect = document.getElementById('sign-pdf-canvas').getBoundingClientRect();
            // Coordenadas relativas al canvas visual
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Actualizar fantasma visual
            const ghost = document.getElementById('sig-ghost');

            // Ajustar tamaño del ghost basado en proporción si es posible, si no default
            // Como signImgData ahora puede ser cualquier cosa, mejor usamos un tamaño fijo por defecto
            // y permitimos que la img interna haga object-contain

            ghost.style.left = (x - 60) + 'px'; // Centrado aprox
            ghost.style.top = (y - 30) + 'px';
            ghost.style.width = '120px';
            ghost.style.height = '60px';
            ghost.classList.remove('hidden');

            // Guardar para generación
            // Las coordenadas deben convertirse a escala PDF original
            // Y recordar que PDF coords empiezan abajo-izquierda, pero PDF.js visual es arriba-izquierda.
            // Necesitamos la altura real de la página PDF para invertir Y.
            signCoords = { x, y };
        }

        async function downloadSignedPDF() {
            if (!signImgData || !signPdfBytes) return;
            showLoader("Firmando...");
            try {
                const doc = await PDFLib.PDFDocument.load(signPdfBytes);
                const page = doc.getPages()[signPageIdx];
                const { width, height } = page.getSize(); // Dimensiones PDF reales

                // Embed png
                const pngImage = await doc.embedPng(signImgData);
                const pngDims = pngImage.scale(0.5); // Escala inicial arbitraria

                // Calcular posición real
                // signCoords.x / signScale = coord X original
                // signCoords.y / signScale = coord Y original (desde arriba)
                // PDF Y = height - coord Y original

                const realX = (signCoords.x - 60) / signScale; // Ajustamos centro
                const realY = height - ((signCoords.y + 30) / signScale); // Invertimos Y

                page.drawImage(pngImage, {
                    x: realX,
                    y: realY,
                    width: 120 / signScale, // Ancho relativo
                    height: 60 / signScale,
                });

                const pdfBytes = await doc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'firmado.pdf'; link.click();
            } catch (e) { console.error(e); alert("Error firmando: " + e.message); } finally { hideLoader(); }
        }

        // ==========================================
        // 12. COMPRIMIR PDF
        // ==========================================
        let compressFile = null;
        document.getElementById('file-input-compress').addEventListener('change', (e) => {
            const f = e.target.files[0]; if (!f) return;
            compressFile = f;
            document.getElementById('compress-upload-area').classList.add('hidden');
            document.getElementById('compress-workspace').classList.remove('hidden');
        });
        function resetCompress() { compressFile = null; document.getElementById('compress-workspace').classList.add('hidden'); document.getElementById('compress-upload-area').classList.remove('hidden'); document.getElementById('file-input-compress').value = ''; }

        async function compressPDF() {
            if (!compressFile) return;
            const level = document.querySelector('input[name="compress-level"]:checked').value;
            showLoader("Comprimiendo PDF...");

            try {
                const ab = await compressFile.arrayBuffer();

                if (level === 'standard') {
                    // Standard: Load and Save (removes garbage) using pdf-lib
                    const doc = await PDFLib.PDFDocument.load(ab);
                    const pdfBytes = await doc.save(); // Default compression is standard
                    downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), 'optimizado_std.pdf');
                } else {
                    // Strong: Rasterize to JPEG using pdf.js -> jsPDF
                    // This is lossy and removes text layer
                    const pdf = await pdfjsLib.getDocument({ data: ab.slice(0) }).promise;
                    const { jsPDF } = window.jspdf;
                    const newDoc = new jsPDF({ format: 'a4', unit: 'mm' });
                    newDoc.deletePage(1);

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 }); // Good quality for reading, but smaller
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;

                        const imgData = canvas.toDataURL('image/jpeg', 0.7); // 70% quality JPEG

                        const pdfPageWidth = 210;
                        const pdfPageHeight = 297;

                        // Fit to page (simple fit, assume A4 usually)
                        newDoc.addPage('a4', viewport.width > viewport.height ? 'l' : 'p');
                        const isLandscape = viewport.width > viewport.height;

                        newDoc.addImage(imgData, 'JPEG', 0, 0, isLandscape ? 297 : 210, isLandscape ? 210 : 297);
                    }
                    newDoc.save('comprimido_fuerte.pdf');
                }

            } catch (e) {
                console.error(e);
                alert("Error durante la compresión: " + e.message);
            } finally {
                hideLoader();
            }
        }

        function downloadBlob(blob, name) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = name;
            link.click();
        }


    </script>
    <script>
        // ==========================================
        // 13. OCR (TEXT RECOGNITION)
        // ==========================================
        let ocrFile = null;
        let ocrPreviewUrl = null;

        document.getElementById('file-input-ocr').addEventListener('change', async (e) => {
            const f = e.target.files[0]; if (!f) return;
            ocrFile = f;
            showLoader("Cargando vista previa...");
            try {
                let url = null;
                if (f.type === 'application/pdf') {
                    const ab = await f.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
                    const page = await pdf.getPage(1); // Page 1 only for now
                    const vp = page.getViewport({ scale: 1.5 });
                    const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
                    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                    url = cvs.toDataURL('image/jpeg');
                } else {
                    url = await blobToDataURL(f);
                }
                ocrPreviewUrl = url;
                document.getElementById('ocr-preview-img').src = url;
                document.getElementById('ocr-upload-area').classList.add('hidden');
                document.getElementById('ocr-workspace').classList.remove('hidden');
                document.getElementById('ocr-result-text').value = '';
            } catch (err) { console.error(err); alert("Error al cargar"); } finally { hideLoader(); }
        });

        async function startOCR() {
            if (!ocrPreviewUrl) return;
            showLoader("Analizando texto (Tesseract)...");
            const lang = document.getElementById('ocr-lang').value;
            try {
                const { data: { text } } = await Tesseract.recognize(ocrPreviewUrl, lang, {
                    logger: m => { } // console.log(m)
                });
                document.getElementById('ocr-result-text').value = text;
            } catch (e) {
                console.error(e); alert("Error en OCR: " + e.message);
            } finally { hideLoader(); }
        }

        function copyOCRText() {
            const txt = document.getElementById('ocr-result-text');
            txt.select();
            document.execCommand('copy');
            alert("Texto copiado");
        }
        function downloadOCRText() {
            const txt = document.getElementById('ocr-result-text').value;
            if (!txt) return;
            const blob = new Blob([txt], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "texto_extraido.txt"; a.click();
        }
        function resetOCR() {
            ocrFile = null; ocrPreviewUrl = null;
            document.getElementById('ocr-workspace').classList.add('hidden');
            document.getElementById('ocr-upload-area').classList.remove('hidden');
            document.getElementById('file-input-ocr').value = '';
        }

        // ==========================================
        // 14. SCAN ENHANCER (BINARIZATION)
        // ==========================================
        let scanImgOriginal = null; // Image Object
        let scanCanvas = document.getElementById('scan-canvas');
        let scanCtx = scanCanvas.getContext('2d', { willReadFrequently: true }); // Optimizado para lecturas

        document.getElementById('file-input-scan').addEventListener('change', async (e) => {
            const f = e.target.files[0]; if (!f) return;
            showLoader("Cargando imagen...");
            try {
                const url = await blobToDataURL(f);
                const img = await loadImage(url);
                scanImgOriginal = img;

                // Fit canvas to image (max dimensions handled by CSS object-contain)
                scanCanvas.width = img.width;
                scanCanvas.height = img.height;

                // Initial Render (Auto Enhance)
                updateScanPreview();

                document.getElementById('scan-upload-area').classList.add('hidden');
                document.getElementById('scan-workspace').classList.remove('hidden');
            } catch (err) { console.error(err); alert("Error al cargar imagen"); } finally { hideLoader(); }
        });

        function updateScanPreview() {
            if (!scanImgOriginal) return;
            // 1. Draw Original
            scanCtx.drawImage(scanImgOriginal, 0, 0);

            // 2. Get Data
            const idata = scanCtx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
            const data = idata.data;
            const threshold = parseInt(document.getElementById('scan-threshold').value);
            document.getElementById('scan-threshold-val').innerText = threshold;
            // const blur = parseFloat(document.getElementById('scan-blur').value); // Not implemented simple js blur manually here for speed, just threshold

            // 3. Simple Binarization Loop
            for (let i = 0; i < data.length; i += 4) {
                // Grayscale
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // Threshold
                const val = avg < threshold ? 0 : 255;
                data[i] = val;     // R
                data[i + 1] = val; // G
                data[i + 2] = val; // B
                // Alpha stays same
            }

            // 4. Put Data Back
            scanCtx.putImageData(idata, 0, 0);
        }

        function downloadScan(fmt) {
            if (!scanImgOriginal) return;
            if (fmt === 'jpg') {
                const a = document.createElement('a');
                a.href = scanCanvas.toDataURL('image/jpeg', 0.9);
                a.download = "scan_mejorado.jpg";
                a.click();
            } else if (fmt === 'pdf') {
                showLoader("Generando PDF...");
                const { jsPDF } = window.jspdf;
                // Determine orientation
                const orient = scanCanvas.width > scanCanvas.height ? 'l' : 'p';
                const doc = new jsPDF({ orientation: orient, unit: 'px', format: [scanCanvas.width, scanCanvas.height] });
                const imgData = scanCanvas.toDataURL('image/jpeg', 0.9);
                doc.addImage(imgData, 'JPEG', 0, 0, scanCanvas.width, scanCanvas.height);
                doc.save("scan_documento.pdf");
                hideLoader();
            }
        }

        function resetScan() {
            scanImgOriginal = null;
            document.getElementById('scan-workspace').classList.add('hidden');
            document.getElementById('scan-upload-area').classList.remove('hidden');
            document.getElementById('file-input-scan').value = '';
            // Reset controls
            document.getElementById('scan-threshold').value = 160;
        }

    </script>
</body>

</html>
